<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EG4-SRP Monitor | Premium Energy Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        :root {
            /* Design System Variables */
            --space-1: 0.25rem;
            --space-2: 0.5rem;
            --space-3: 0.75rem;
            --space-4: 1rem;
            --space-5: 1.25rem;
            --space-6: 1.5rem;
            --space-8: 2rem;
            --space-10: 2.5rem;
            --space-12: 3rem;
            --space-16: 4rem;
            
            /* Enhanced Color Palette */
            --color-bg-primary: #0f172a;
            --color-bg-secondary: #1e293b;
            --color-bg-tertiary: rgba(30, 41, 59, 0.9);
            --color-accent-blue: #3b82f6;
            --color-accent-green: #10b981;
            --color-accent-red: #ef4444;
            --color-accent-yellow: #f59e0b;
            --color-text-primary: #f1f5f9;
            --color-text-secondary: #e2e8f0;
            --color-text-tertiary: #94a3b8;
            --color-border: rgba(51, 65, 85, 0.6);
            
            /* Typography Scale */
            --font-size-xs: 0.75rem;
            --font-size-sm: 0.875rem;
            --font-size-base: 1rem;
            --font-size-lg: 1.125rem;
            --font-size-xl: 1.25rem;
            --font-size-2xl: 1.5rem;
            --font-size-3xl: 1.875rem;
            --font-size-4xl: 2.25rem;
            
            /* Font Weights */
            --font-weight-normal: 400;
            --font-weight-medium: 500;
            --font-weight-semibold: 600;
            --font-weight-bold: 700;
            
            /* Border Radius */
            --radius-sm: 0.375rem;
            --radius-md: 0.5rem;
            --radius-lg: 0.75rem;
            --radius-xl: 1rem;
            --radius-2xl: 1.5rem;
            --radius-full: 9999px;
            
            /* Shadows */
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: 
                radial-gradient(circle at 20% 50%, rgba(59, 130, 246, 0.08) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(16, 185, 129, 0.08) 0%, transparent 50%),
                radial-gradient(circle at 50% 100%, rgba(99, 102, 241, 0.05) 0%, transparent 60%),
                linear-gradient(180deg, var(--color-bg-primary) 0%, var(--color-bg-secondary) 100%);
            color: var(--color-text-secondary);
            padding: 0;
            line-height: 1.6;
            letter-spacing: -0.011em;
            min-height: 100vh;
            font-weight: var(--font-weight-normal);
            position: relative;
            overflow-x: hidden;
            font-size: var(--font-size-base);
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        
        /* ENHANCED: World-class mobile improvements for small screens */
        @media (max-width: 480px) {
            body {
                padding: 0.75rem;
                font-size: 16px;
                line-height: 1.5;
            }
            
            .header-logo {
                margin-bottom: 1.5rem;
            }
            
            .header-logo img {
                height: 120px;
            }
            
            .tabs {
                padding: 0.25rem;
                gap: 0.125rem;
            }
            
            .tab {
                padding: 0.875rem 0.5rem;
                font-size: 0.8rem;
                min-height: 44px;
            }
            
            .card {
                padding: 1.5rem 1.25rem;
                margin-bottom: 1.25rem;
            }
            
            /* Enhanced chart button spacing for touch */
            .chart-type-btn {
                padding: 0.875rem 0.625rem !important;
                font-size: 0.8rem !important;
                min-height: 48px !important;
                flex: 1;
                margin: 0.125rem;
            }
            
            /* CRITICAL: Enhanced form spacing using 8px grid system */
            .form-group {
                margin-bottom: 2rem;
                padding-bottom: 1.5rem;
                border-bottom: 1px solid rgba(51, 65, 85, 0.3);
            }
            
            .form-group:last-child {
                border-bottom: none;
            }
            
            .form-group h3 {
                font-size: 1.0625rem;
                margin-bottom: 1.25rem;
                color: #f1f5f9;
                font-weight: 600;
            }
            
            .form-group h4 {
                font-size: 0.9375rem;
                margin-bottom: 1rem;
                color: #cbd5e1;
                font-weight: 500;
            }
            
            /* Enhanced credential section spacing */
            .credential-section {
                margin-bottom: 2rem;
                padding: 1.5rem;
                background: rgba(15, 23, 42, 0.6);
                border-radius: 0.75rem;
                border: 1px solid rgba(51, 65, 85, 0.4);
            }
            
            /* Better input field spacing */
            .form-group > div {
                margin-bottom: 1.5rem;
            }
            
            .form-group input,
            .form-group select {
                margin-bottom: 0.75rem;
            }
            
            /* Optimize metric display for touch */
            .metric {
                padding: 1.5rem 1.25rem;
                margin-bottom: 1rem;
            }
            
            .value {
                font-size: 1.125rem !important;
                padding: 0.75rem !important;
            }
            
            /* Enhanced button spacing and touch targets */
            button {
                margin-bottom: 0.75rem;
                font-size: 0.875rem;
                min-height: 44px;
                padding: 0.75rem 1rem;
            }
            
            /* Improved log viewer for mobile */
            #log-container {
                height: 250px !important;
                font-size: 0.8125rem !important;
                line-height: 1.4;
                padding: 1rem;
            }
            
            /* Better alert threshold section spacing */
            .alert-threshold-section {
                margin-bottom: 2rem;
                padding: 1.25rem;
                background: rgba(30, 41, 59, 0.4);
                border-radius: 0.75rem;
                border-left: 3px solid rgba(59, 130, 246, 0.6);
            }
            
            /* Enhanced information hierarchy */
            .system-status-grid {
                gap: 1rem;
            }
            
            /* Better chart legend spacing */
            .chart-legend {
                margin-top: 1rem;
                padding: 1rem;
                font-size: 0.8125rem;
                line-height: 1.4;
            }
        }
        
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                radial-gradient(circle at 20% 80%, rgba(99, 179, 237, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 90% 10%, rgba(245, 158, 11, 0.1) 0%, transparent 50%);
            pointer-events: none;
            z-index: -1;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        /* World-class header design */
        .main-header {
            background: linear-gradient(135deg, rgba(30, 41, 59, 0.95) 0%, rgba(15, 23, 42, 0.95) 100%);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(51, 65, 85, 0.5);
            border-radius: 1.5rem;
            margin-bottom: 2rem;
            padding: 1.5rem 2rem;
            box-shadow: 
                0 20px 25px -5px rgba(0, 0, 0, 0.3),
                0 10px 10px -5px rgba(0, 0, 0, 0.04),
                inset 0 1px 0 rgba(255, 255, 255, 0.1);
        }
        
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 2rem;
        }
        
        .logo-section {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .logo-wrapper {
            width: 60px;
            height: 60px;
            overflow: hidden;
            position: relative;
        }
        
        .logo-img {
            height: 60px;
            width: auto;
            position: absolute;
            left: 0;
            top: 0;
            clip-path: polygon(0 0, 50% 0, 50% 100%, 0 100%);
            filter: drop-shadow(0 4px 8px rgba(59, 130, 246, 0.3));
        }
        
        .brand-text h1 {
            font-size: 1.5rem;
            font-weight: 800;
            color: #f1f5f9;
            margin: 0;
            line-height: 1.2;
            letter-spacing: -0.05em;
        }
        
        .brand-text p {
            font-size: 0.875rem;
            color: #94a3b8;
            margin: 0;
            font-weight: 500;
        }
        
        .main-nav {
            display: flex;
            gap: 0.5rem;
            background: rgba(15, 23, 42, 0.5);
            padding: 0.375rem;
            border-radius: 0.75rem;
            border: 1px solid rgba(51, 65, 85, 0.5);
        }
        
        .nav-tab {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 1.5rem;
            background: transparent;
            border: none;
            border-radius: 0.5rem;
            color: #94a3b8;
            font-weight: 600;
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.2s ease;
            white-space: nowrap;
            font-family: inherit;
        }
        
        .nav-tab:hover {
            color: #e2e8f0;
            background: rgba(59, 130, 246, 0.1);
        }
        
        .nav-tab.active {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white;
            box-shadow: 
                0 4px 12px rgba(59, 130, 246, 0.4),
                inset 0 1px 0 rgba(255, 255, 255, 0.2);
        }
        
        .nav-tab svg {
            width: 18px;
            height: 18px;
        }
        
        /* World-class integrated header design */
        .header {
            position: sticky;
            top: 0;
            z-index: 1000;
            background: rgba(15, 23, 42, 0.8);
            backdrop-filter: blur(20px) saturate(180%);
            border-bottom: 1px solid rgba(51, 65, 85, 0.3);
            margin: -2rem -2rem 3rem -2rem;
            padding: 0 2rem;
            transition: all 0.3s ease;
        }
        
        .header.scrolled {
            background: rgba(15, 23, 42, 0.95);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
        }
        
        .header-container {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1rem 0;
        }
        
        .logo-nav-group {
            display: flex;
            align-items: center;
            gap: 3rem;
        }
        
        .header-logo {
            display: flex;
            align-items: center;
            gap: 1rem;
            text-decoration: none;
            position: relative;
        }
        
        .logo-icon {
            width: 48px;
            height: 48px;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .logo-icon img {
            height: 48px;
            width: auto;
            filter: 
                drop-shadow(0 2px 8px rgba(59, 130, 246, 0.3))
                brightness(1.1);
            /* Clip exactly half the image to show only left logo */
            clip-path: polygon(0 0, 50% 0, 50% 100%, 0 100%);
            transform: translateX(-50%);
        }
        
        .logo-text {
            display: flex;
            flex-direction: column;
            gap: 0.125rem;
        }
        
        .logo-text .primary {
            font-size: 1.25rem;
            font-weight: 700;
            color: #f1f5f9;
            letter-spacing: -0.05em;
            line-height: 1;
        }
        
        .logo-text .secondary {
            font-size: 0.75rem;
            font-weight: 500;
            color: #64748b;
            text-transform: uppercase;
            letter-spacing: 0.1em;
        }
        
        .header-nav {
            display: flex;
            gap: 0.5rem;
            background: rgba(30, 41, 59, 0.6);
            padding: 0.375rem;
            border-radius: 0.75rem;
            border: 1px solid rgba(51, 65, 85, 0.3);
        }
        
        .nav-item {
            padding: 0.625rem 1.25rem;
            background: transparent;
            border: none;
            color: #94a3b8;
            cursor: pointer;
            border-radius: 0.5rem;
            transition: all 0.2s ease;
            font-size: 0.875rem;
            font-weight: 500;
            position: relative;
            white-space: nowrap;
        }
        
        .nav-item:hover {
            color: #e2e8f0;
            background: rgba(51, 65, 85, 0.3);
        }
        
        .nav-item.active {
            background: rgba(59, 130, 246, 0.2);
            color: #60a5fa;
            font-weight: 600;
        }
        
        .nav-item.active::after {
            content: '';
            position: absolute;
            bottom: -0.375rem;
            left: 50%;
            transform: translateX(-50%);
            width: 24px;
            height: 3px;
            background: #3b82f6;
            border-radius: 3px;
        }
        
        .header-actions {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .status-indicator {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid rgba(16, 185, 129, 0.3);
            border-radius: 2rem;
            font-size: 0.75rem;
            font-weight: 500;
            color: #10b981;
        }
        
        .status-dot {
            width: 6px;
            height: 6px;
            background: #10b981;
            border-radius: 50%;
            animation: statusPulse 2s infinite;
        }
        
        @keyframes statusPulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.6; transform: scale(1.2); }
        }
        
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: clamp(1rem, 2vw, 2rem);
            margin-bottom: clamp(1.5rem, 3vw, 2.5rem);
        }
        
        .card {
            background: rgba(30, 41, 59, 0.9);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(51, 65, 85, 0.6);
            border-radius: 1rem;
            padding: clamp(1.25rem, 3vw, 2rem);
            box-shadow: 
                0 20px 25px -5px rgba(0, 0, 0, 0.3),
                0 10px 10px -5px rgba(0, 0, 0, 0.04),
                inset 0 1px 0 rgba(255, 255, 255, 0.1);
            position: relative;
            overflow: hidden;
        }
        
        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, rgba(59, 130, 246, 0.5), transparent);
        }
        
        .card h2 {
            margin-bottom: 1.5rem;
            color: #f1f5f9;
            font-size: clamp(1.125rem, 2.5vw, 1.375rem);
            font-weight: 700;
            letter-spacing: -0.05em;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);
        }
        
        .card h2::before {
            content: '';
            width: 4px;
            height: 1.5rem;
            background: linear-gradient(to bottom, #60a5fa, #3b82f6);
            border-radius: 2px;
        }
        
        .metric {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding: 1.75rem 1.5rem;
            background: linear-gradient(145deg, rgba(30, 35, 55, 0.95), rgba(37, 41, 70, 0.8));
            backdrop-filter: blur(24px);
            border-radius: 1.25rem;
            border: 1px solid rgba(99, 179, 237, 0.3);
            font-size: 1rem;
            font-weight: 500;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            box-shadow: 
                0 6px 20px rgba(0, 0, 0, 0.2),
                inset 0 1px 0 rgba(255, 255, 255, 0.15);
        }
        
        .metric::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, rgba(99, 179, 237, 0.6), transparent);
            border-radius: 1rem 1rem 0 0;
        }
        
        .metric:hover {
            background: linear-gradient(145deg, rgba(30, 35, 55, 1), rgba(37, 41, 70, 0.95));
            border-color: rgba(99, 179, 237, 0.5);
            transform: translateY(-3px);
            box-shadow: 
                0 12px 40px rgba(0, 0, 0, 0.3),
                0 0 0 1px rgba(99, 179, 237, 0.3),
                inset 0 1px 0 rgba(255, 255, 255, 0.2);
        }
        
        .metric:last-child {
            margin-bottom: 0;
        }
        
        
        .value {
            font-weight: 700;
            color: #f8fafc;
            font-size: 1.75rem;
            letter-spacing: -0.03em;
            font-variant-numeric: tabular-nums;
            padding: 1rem 1.5rem;
            background: linear-gradient(135deg, rgba(15, 23, 42, 0.95), rgba(30, 41, 59, 0.85));
            backdrop-filter: blur(16px);
            border-radius: 1rem;
            border: 1px solid rgba(99, 179, 237, 0.4);
            min-width: 140px;
            text-align: center;
            text-shadow: 0 2px 6px rgba(0, 0, 0, 0.6);
            box-shadow: 
                inset 0 1px 3px rgba(0, 0, 0, 0.3),
                0 4px 12px rgba(0, 0, 0, 0.15),
                0 0 0 1px rgba(255, 255, 255, 0.1);
            position: relative;
            transition: all 0.2s ease;
        }
        
        .value::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            border-radius: 1rem 1rem 0 0;
        }
        
        .metric:hover .value {
            transform: scale(1.02);
            box-shadow: 
                inset 0 1px 3px rgba(0, 0, 0, 0.4),
                0 6px 16px rgba(0, 0, 0, 0.2),
                0 0 0 1px rgba(255, 255, 255, 0.15);
        }
        
        .positive { 
            color: #10b981;
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.15), rgba(5, 150, 105, 0.1));
            border-color: rgba(16, 185, 129, 0.4);
            box-shadow: 
                0 0 20px rgba(16, 185, 129, 0.15),
                inset 0 1px 2px rgba(16, 185, 129, 0.1);
        }
        .positive::after {
            background: linear-gradient(90deg, transparent, rgba(16, 185, 129, 0.3), transparent);
        }
        
        .negative { 
            color: #ef4444;
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.15), rgba(220, 38, 38, 0.1));
            border-color: rgba(239, 68, 68, 0.4);
            box-shadow: 
                0 0 20px rgba(239, 68, 68, 0.15),
                inset 0 1px 2px rgba(239, 68, 68, 0.1);
        }
        .negative::after {
            background: linear-gradient(90deg, transparent, rgba(239, 68, 68, 0.3), transparent);
        }
        
        .warning { 
            color: #f59e0b;
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.15), rgba(217, 119, 6, 0.1));
            border-color: rgba(245, 158, 11, 0.4);
            box-shadow: 
                0 0 20px rgba(245, 158, 11, 0.15),
                inset 0 1px 2px rgba(245, 158, 11, 0.1);
        }
        .warning::after {
            background: linear-gradient(90deg, transparent, rgba(245, 158, 11, 0.3), transparent);
        }
        
        /* Battery level specific styling */
        .battery-critical {
            color: #ef4444;
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.2), rgba(220, 38, 38, 0.15));
            border-color: rgba(239, 68, 68, 0.5);
            box-shadow: 
                0 0 30px rgba(239, 68, 68, 0.3),
                inset 0 1px 2px rgba(239, 68, 68, 0.2);
            animation: batteryPulse 2s infinite;
        }
        
        .battery-low {
            color: #f59e0b;
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.2), rgba(217, 119, 6, 0.15));
            border-color: rgba(245, 158, 11, 0.5);
            box-shadow: 
                0 0 25px rgba(245, 158, 11, 0.2),
                inset 0 1px 2px rgba(245, 158, 11, 0.15);
        }
        
        .battery-good {
            color: #10b981;
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.2), rgba(5, 150, 105, 0.15));
            border-color: rgba(16, 185, 129, 0.5);
            box-shadow: 
                0 0 25px rgba(16, 185, 129, 0.2),
                inset 0 1px 2px rgba(16, 185, 129, 0.15);
        }
        
        @keyframes batteryPulse {
            0%, 100% { 
                box-shadow: 
                    0 0 30px rgba(239, 68, 68, 0.3),
                    inset 0 1px 2px rgba(239, 68, 68, 0.2);
            }
            50% { 
                box-shadow: 
                    0 0 40px rgba(239, 68, 68, 0.5),
                    inset 0 1px 2px rgba(239, 68, 68, 0.3);
            }
        }
        
        /* Loading States and Animations */
        .loading {
            position: relative;
            overflow: hidden;
        }
        
        .loading::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
            animation: shimmer 1.5s infinite;
        }
        
        @keyframes shimmer {
            0% { left: -100%; }
            100% { left: 100%; }
        }
        
        .skeleton {
            background: linear-gradient(90deg, #334155 25%, #475569 50%, #334155 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
            border-radius: 0.25rem;
        }
        
        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
        
        /* Enhanced Button Styles */
        button {
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }
        
        button:hover:not(:disabled) {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }
        
        button:active:not(:disabled) {
            transform: translateY(0);
        }
        
        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        /* Enhanced Card Styles */
        .card {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            backdrop-filter: blur(10px);
            position: relative;
        }
        
        .card:hover {
            border-color: #475569;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }
        
        /* Smooth Transitions */
        .metric .value {
            transition: all 0.3s ease;
        }
        
        .value.updating {
            animation: pulse 1s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.8; transform: scale(1.02); }
        }
        
        /* Energy flow visualization */
        .energy-flow {
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 1rem 0;
        }
        
        .energy-flow::before {
            content: '';
            position: absolute;
            width: 100%;
            height: 2px;
            background: linear-gradient(90deg, #10b981, #3b82f6, #8b5cf6);
            animation: energyFlow 3s linear infinite;
        }
        
        @keyframes energyFlow {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }
        
        /* Toast Notifications */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #1e293b;
            border: 1px solid #334155;
            border-radius: 0.5rem;
            padding: 1rem 1.5rem;
            color: #e2e8f0;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5);
            z-index: 1000;
            transform: translateX(100%);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .toast.show {
            transform: translateX(0);
        }
        
        .toast.success {
            border-left: 4px solid #22c55e;
        }
        
        .toast.error {
            border-left: 4px solid #ef4444;
        }
        
        .toast.warning {
            border-left: 4px solid #f59e0b;
        }
        
        .config-section {
            background: rgba(30, 41, 59, 0.9);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(51, 65, 85, 0.6);
            border-radius: 1rem;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 
                0 20px 25px -5px rgba(0, 0, 0, 0.2),
                0 10px 10px -5px rgba(0, 0, 0, 0.04),
                inset 0 1px 0 rgba(255, 255, 255, 0.1);
            position: relative;
        }
        
        .config-section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, rgba(59, 130, 246, 0.5), transparent);
        }
        
        .form-group {
            margin-bottom: 1.5rem;
        }
        
        label {
            display: block;
            margin-bottom: 0.5rem;
            color: #94a3b8;
        }
        
        input[type="text"],
        input[type="email"],
        input[type="password"],
        input[type="number"],
        select {
            width: 100%;
            padding: 0.75rem 1rem;
            background: rgba(15, 23, 42, 0.8);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(51, 65, 85, 0.6);
            border-radius: 0.75rem;
            color: #e2e8f0;
            font-size: 1rem;
            transition: all 0.2s ease;
            font-family: inherit;
        }
        
        input:focus,
        select:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
            background: rgba(15, 23, 42, 0.9);
        }
        
        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        button {
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 0.75rem;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
            box-shadow: 
                0 4px 12px rgba(59, 130, 246, 0.3),
                inset 0 1px 0 rgba(255, 255, 255, 0.2);
            transition: all 0.2s ease;
            border: 1px solid rgba(59, 130, 246, 0.5);
        }
        
        button:hover:not(:disabled) {
            background: linear-gradient(135deg, #2563eb, #1e40af);
            transform: translateY(-2px);
            box-shadow: 
                0 8px 20px rgba(59, 130, 246, 0.4),
                inset 0 1px 0 rgba(255, 255, 255, 0.2);
        }
        
        button:active:not(:disabled) {
            transform: translateY(0);
            box-shadow: 
                0 2px 8px rgba(59, 130, 246, 0.3),
                inset 0 1px 0 rgba(255, 255, 255, 0.2);
        }
        
        /* Enhanced Tab styles */
        .tabs {
            display: flex;
            gap: 0.5rem;
            background: rgba(15, 23, 42, 0.6);
            border-radius: 1rem;
            padding: 0.5rem;
            margin-bottom: 2rem;
            position: relative;
            border: 1px solid rgba(51, 65, 85, 0.3);
            backdrop-filter: blur(10px);
        }
        
        .tab {
            padding: 1rem 2rem;
            background: transparent;
            border: none;
            color: #94a3b8;
            cursor: pointer;
            border-radius: 0.75rem;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-size: 1rem;
            font-weight: 600;
            position: relative;
            min-height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex: 1;
        }
        
        .tab:hover:not(.active) {
            color: #e2e8f0;
            background: rgba(255, 255, 255, 0.1);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
        
        .tab.active {
            color: #ffffff;
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            box-shadow: 
                0 4px 12px rgba(59, 130, 246, 0.4),
                inset 0 1px 0 rgba(255, 255, 255, 0.2);
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
        }
        
        /* ENHANCED: World-class mobile-first responsive design */
        @media (max-width: 768px) {
            body {
                padding: 1rem;
                font-size: 16px;
                line-height: 1.6;
            }
            
            /* Enhanced form accessibility and spacing */
            .form-group {
                margin-bottom: 2rem;
                padding-bottom: 1.5rem;
                border-bottom: 1px solid rgba(51, 65, 85, 0.2);
            }
            
            .form-group:last-child {
                border-bottom: none;
            }
            
            .form-group .grid {
                grid-template-columns: 1fr !important;
                gap: 2rem;
            }
            
            .threshold-grid {
                grid-template-columns: 1fr !important;
                gap: 1.5rem;
            }
            
            /* Enhanced credential section design */
            .credential-section {
                background: rgba(15, 23, 42, 0.5);
                border-radius: 1rem;
                padding: 1.5rem;
                margin-bottom: 1.5rem;
                border: 1px solid rgba(51, 65, 85, 0.3);
            }
            
            .credential-section h4 {
                color: #60a5fa;
                font-weight: 600;
                margin-bottom: 1.25rem;
                font-size: 1rem;
            }
            
            /* Better input field design */
            .form-group input,
            .form-group select {
                background: rgba(30, 41, 59, 0.8);
                border: 1px solid rgba(71, 85, 105, 0.6);
                border-radius: 0.5rem;
                padding: 0.875rem 1rem;
                font-size: 16px;
                color: #e2e8f0;
                width: 100%;
                margin-bottom: 0.75rem;
                transition: all 0.2s ease;
            }
            
            .form-group input:focus,
            .form-group select:focus {
                outline: none;
                border-color: #60a5fa;
                box-shadow: 0 0 0 3px rgba(96, 165, 250, 0.1);
            }
            
            /* Enhanced chart button spacing */
            .chart-type-btn {
                min-height: 48px;
                padding: 0.875rem 1rem;
                margin: 0.25rem;
                font-size: 0.875rem;
                border-radius: 0.75rem;
            }
            
            /* Better system status grid */
            .system-status-grid {
                grid-template-columns: 1fr;
                gap: 1.5rem;
            }
            
            /* Enhanced log section */
            #log-container {
                background: rgba(15, 23, 42, 0.8);
                border-radius: 0.75rem;
                padding: 1rem;
                font-size: 0.875rem;
                line-height: 1.5;
                max-height: 300px;
            }
            
            /* Critical: Fix checkbox accessibility */
            input[type="checkbox"] {
                min-width: 20px;
                min-height: 20px;
                margin-right: 12px;
                transform: scale(1.2); /* Make checkboxes more tappable */
            }
            
            label {
                display: flex;
                align-items: center;
                min-height: 44px; /* Ensure label touch target meets standards */
                padding: 8px 0;
                cursor: pointer;
            }
            
            /* Fix spinbutton usability */
            input[type="number"] {
                -webkit-appearance: none;
                -moz-appearance: textfield;
                text-align: center;
                font-size: 18px !important; /* Larger text for better visibility */
            }
            
            /* Better spacing for time pickers */
            .time-picker {
                display: flex;
                align-items: center;
                gap: 0.5rem;
                min-height: 44px;
            }
            
            .time-picker input {
                flex: 1;
                max-width: 80px;
            }
            
            .tabs {
                gap: 0.25rem;
                padding: 0.375rem;
                margin-bottom: 1.5rem;
                border-radius: 1rem;
            }
            
            .tab {
                flex: 1;
                padding: 1rem 0.875rem;
                font-size: 0.875rem;
                font-weight: 700;
                min-height: 48px; /* Apple's minimum touch target */
                border-radius: 0.75rem;
            }
            
            .card {
                padding: 1.75rem 1.5rem;
                border-radius: 1.25rem;
            }
            
            .grid {
                grid-template-columns: 1fr;
                gap: 1.25rem;
            }
            
            /* Enhanced mobile metric cards */
            .metric {
                padding: 1.5rem;
                margin-bottom: 1.25rem;
                border-radius: 1.25rem;
            }
            
            /* Critical: Improve mobile information hierarchy */
            .card h2 {
                font-size: 1.25rem;
                margin-bottom: 1rem;
                line-height: 1.3;
            }
            
            .card h3 {
                font-size: 1.1rem;
                margin-bottom: 0.75rem;
                line-height: 1.3;
            }
            
            .card h4 {
                font-size: 1rem;
                margin-bottom: 0.5rem;
                line-height: 1.3;
            }
            
            /* Better mobile status display */
            .status-grid {
                display: grid;
                grid-template-columns: 1fr;
                gap: 1rem;
            }
            
            .status-item {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 1rem;
                background: rgba(15, 23, 42, 0.6);
                border-radius: 0.75rem;
                min-height: 44px;
            }
            
            /* Improve log viewer for mobile */
            #log-container {
                font-size: 0.8rem !important;
                line-height: 1.4 !important;
                padding: 1rem !important;
            }
            
            .value {
                font-size: 1.5rem;
                padding: 0.875rem 1.25rem;
                min-width: 120px;
            }
            
            /* Enhanced touch-friendly chart buttons */
            .chart-type-btn {
                padding: 1rem 1.25rem;
                font-size: 0.875rem;
                min-height: 48px;
                margin: 0.25rem;
                border-radius: 0.75rem !important;
                transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
                /* Ensure adequate touch target spacing */
                min-width: 80px;
                display: flex;
                align-items: center;
                justify-content: center;
            }
            
            /* Improved form elements for mobile */
            input[type="text"],
            input[type="email"], 
            input[type="password"],
            input[type="number"],
            select {
                padding: 1rem;
                font-size: 16px; /* Prevent zoom on iOS */
                min-height: 48px;
                border-radius: 0.75rem;
            }
            
            button {
                min-height: 48px;
                padding: 1rem 1.5rem;
                font-size: 0.9rem;
                border-radius: 0.75rem;
            }
            
            .metric {
                padding: 1rem;
                flex-direction: column;
                gap: 0.5rem;
                text-align: center;
            }
            
            .metric span:first-child {
                justify-content: center;
            }
            
            .value {
                min-width: auto;
                width: 100%;
                text-align: center;
                font-size: 1.25rem;
                padding: 0.75rem;
            }
            
            .chart-type-btn {
                padding: 0.75rem 1rem;
                font-size: 0.8rem;
                min-height: 44px !important; /* Ensure minimum touch target */
                flex: 1;
                margin: 0.125rem;
            }
            
            .header-logo {
                margin-bottom: 2rem;
                max-width: 200px;
            }
            
            .header-logo img {
                height: 150px;
            }
        }
        
        /* Premium animations */
        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .card {
            animation: slideInUp 0.6s ease-out forwards;
        }
        
        .card:nth-child(2) { animation-delay: 0.1s; }
        .card:nth-child(3) { animation-delay: 0.2s; }
        .card:nth-child(4) { animation-delay: 0.3s; }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* Enhanced Chart Type Button System */
        .chart-type-btn {
            padding: 0.875rem 1.5rem;
            background: rgba(51, 65, 85, 0.7);
            backdrop-filter: blur(16px);
            border: 1px solid rgba(71, 85, 105, 0.5);
            color: #94a3b8;
            font-size: 0.875rem;
            font-weight: 600;
            cursor: pointer;
            border-radius: 0.75rem;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
            min-height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .chart-type-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
            border-radius: 0.75rem 0.75rem 0 0;
        }
        
        .chart-type-btn:first-child {
            border-radius: 0.75rem 0.5rem 0.5rem 0.75rem;
        }
        
        .chart-type-btn:last-child {
            border-radius: 0.5rem 0.75rem 0.75rem 0.5rem;
        }
        
        .chart-type-btn:hover:not(.active) {
            background: rgba(71, 85, 105, 0.9);
            color: #f1f5f9;
            transform: translateY(-2px);
            border-color: rgba(99, 179, 237, 0.4);
            box-shadow: 
                0 6px 16px rgba(0, 0, 0, 0.2),
                0 0 0 1px rgba(99, 179, 237, 0.2);
        }
        
        .chart-type-btn.active {
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            border-color: #3b82f6;
            color: white;
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.4);
            transform: translateY(-1px);
            box-shadow: 
                0 6px 20px rgba(59, 130, 246, 0.4),
                inset 0 1px 0 rgba(255, 255, 255, 0.25),
                0 0 0 1px rgba(59, 130, 246, 0.3);
        }
        
        .chart-type-btn.active::before {
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
        }
        
        .alert {
            background: #dc2626;
            color: white;
            padding: 1rem;
            border-radius: 0.25rem;
            margin-bottom: 1rem;
            display: none;
        }
        
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 0.75rem;
            position: relative;
            box-shadow: 0 0 10px currentColor;
        }
        
        .status-indicator.online { 
            background: #10b981;
            animation: pulse-green 2s infinite;
        }
        
        .status-indicator.offline { 
            background: #ef4444;
            animation: pulse-red 2s infinite;
        }
        
        @keyframes pulse-green {
            0%, 100% { box-shadow: 0 0 5px #10b981; }
            50% { box-shadow: 0 0 20px #10b981, 0 0 30px #10b981; }
        }
        
        @keyframes pulse-red {
            0%, 100% { box-shadow: 0 0 5px #ef4444; }
            50% { box-shadow: 0 0 20px #ef4444, 0 0 30px #ef4444; }
        }
        
        /* Professional Status Badge System */
        .status-badge {
            display: inline-flex;
            align-items: center;
            padding: 0.5rem 1rem;
            border-radius: 2rem;
            font-size: 0.875rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            transition: all 0.2s ease;
            backdrop-filter: blur(8px);
        }
        
        .status-badge::before {
            content: '';
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 0.5rem;
            animation: statusPulse 2s infinite;
        }
        
        .status-badge.online {
            background: rgba(16, 185, 129, 0.15);
            color: #10b981;
            border: 1px solid rgba(16, 185, 129, 0.3);
        }
        
        .status-badge.online::before {
            background: #10b981;
            box-shadow: 0 0 8px rgba(16, 185, 129, 0.6);
        }
        
        .status-badge.offline {
            background: rgba(239, 68, 68, 0.15);
            color: #ef4444;
            border: 1px solid rgba(239, 68, 68, 0.3);
        }
        
        .status-badge.offline::before {
            background: #ef4444;
            box-shadow: 0 0 8px rgba(239, 68, 68, 0.6);
        }
        
        .status-badge.warning {
            background: rgba(245, 158, 11, 0.15);
            color: #f59e0b;
            border: 1px solid rgba(245, 158, 11, 0.3);
        }
        
        .status-badge.warning::before {
            background: #f59e0b;
            box-shadow: 0 0 8px rgba(245, 158, 11, 0.6);
        }
        
        @keyframes statusPulse {
            0%, 100% { 
                opacity: 1;
                transform: scale(1);
            }
            50% { 
                opacity: 0.7;
                transform: scale(1.1);
            }
        }
        
        .threshold-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }
        
        /* Modal styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
        }
        
        .modal-content {
            background-color: #1e293b;
            margin: 10% auto;
            padding: 2rem;
            border: 1px solid #334155;
            border-radius: 0.5rem;
            width: 90%;
            max-width: 500px;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }
        
        .close {
            color: #94a3b8;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        
        .close:hover,
        .close:focus {
            color: #f1f5f9;
        }
        
        .link-button {
            background: none;
            border: none;
            color: #3b82f6;
            text-decoration: underline;
            cursor: pointer;
            font-size: inherit;
            padding: 0;
        }
        
        .link-button:hover {
            color: #2563eb;
        }
    </style>
</head>
<body>
    <div class="container">
        <div id="alert" class="alert"></div>
        
        <!-- Modern Integrated Header -->
        <header class="main-header">
            <div class="header-content">
                <div class="logo-section">
                    <div class="logo-wrapper">
                        <img src="/eg4_logo.png" alt="EG4 Monitor" class="logo-img" />
                    </div>
                    <div class="brand-text">
                        <h1>EG4 Monitor</h1>
                        <p>Energy Management System</p>
                    </div>
                </div>
                <nav class="main-nav">
                    <button class="nav-tab active" onclick="switchTab('monitoring')">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="3" y="3" width="18" height="18" rx="2" />
                            <path d="M9 9h6v6h-6z" />
                        </svg>
                        <span>Monitoring</span>
                    </button>
                    <button class="nav-tab" onclick="switchTab('alerts')">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="3" />
                            <path d="M12 1v6m0 6v6m6.36-10.36l-4.24 4.24M7.88 7.88L3.64 3.64m16.72 16.72l-4.24-4.24M7.88 16.12L3.64 20.36" />
                        </svg>
                        <span>Configuration</span>
                    </button>
                </nav>
            </div>
        </header>
        
        <!-- Monitoring Tab -->
        <div id="monitoring-tab" class="tab-content active">
            <!-- SRP Energy Usage Chart at Top -->
            <div class="card" style="margin-bottom: 1.5rem; position: relative; overflow: hidden;">
                <div class="energy-flow" style="position: absolute; top: 0; left: 0; right: 0; height: 2px; z-index: 1;"></div>
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                    <div>
                        <h2 style="margin: 0;">SRP Energy Usage</h2>
                        <div style="color: #64748b; font-size: 0.75rem; margin-top: 0.25rem;">
                            Chart data: <span id="chart-last-update">--</span> | Peak Demand: <span class="value warning" style="font-size: 1rem;" id="peak-demand-header">-- kW</span>
                        </div>
                    </div>
                    <button onclick="loadSRPChart()" style="padding: 0.5rem 1rem; font-size: 0.875rem;">Refresh Chart</button>
                </div>
                <!-- Chart Type Selector -->
                <div style="display: flex; gap: 0.5rem; margin-bottom: 1rem;">
                    <button class="chart-type-btn active" data-chart-type="net" onclick="switchChartType('net')">Net energy</button>
                    <button class="chart-type-btn" data-chart-type="generation" onclick="switchChartType('generation')">Generation</button>
                    <button class="chart-type-btn" data-chart-type="usage" onclick="switchChartType('usage')">Usage</button>
                    <button class="chart-type-btn" data-chart-type="demand" onclick="switchChartType('demand')">Demand</button>
                </div>
                <div style="position: relative; height: 400px;">
                    <canvas id="srpChart"></canvas>
                </div>
                <div id="chart-info" style="margin-top: 0.5rem; color: #64748b; font-size: 0.75rem;">
                    <!-- Chart description updated by switchChartType() -->
                </div>
            </div>
            
            <!-- EG4 and Enphase Status Side by Side -->
            <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 1rem;">
            <!-- EG4 Status -->
            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                    <div>
                        <h2 style="margin: 0;">EG4 Inverter Status</h2>
                        <div style="color: #64748b; font-size: 0.75rem; margin-top: 0.25rem;">
                            Last updated: <span id="eg4-last-update">--</span>
                        </div>
                    </div>
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                        <label style="display: flex; align-items: center; gap: 0.5rem; margin: 0;">
                            <input type="checkbox" id="auto-refresh" checked style="cursor: pointer;">
                            <span style="font-size: 0.875rem;">Auto-refresh</span>
                        </label>
                        <select id="refresh-interval" style="background: #1e293b; color: #e2e8f0; border: 1px solid #475569; padding: 0.25rem 0.5rem; border-radius: 0.25rem; font-size: 0.875rem;">
                            <option value="30">30s</option>
                            <option value="60" selected>60s</option>
                            <option value="120">2m</option>
                            <option value="300">5m</option>
                        </select>
                        <button onclick="refreshEG4(event)" style="padding: 0.5rem 1rem; font-size: 0.875rem;">Refresh Now</button>
                    </div>
                </div>
                <div class="metric">
                    <span style="display: flex; align-items: center; gap: 0.75rem;">
                        <span style="font-size: 1.5rem; color: #10b981;">🔋</span>
                        <span style="font-weight: 600;">Battery SOC</span>
                    </span>
                    <span class="value" id="battery-soc">--</span>
                </div>
                <div class="metric">
                    <span style="display: flex; align-items: center; gap: 0.75rem;">
                        <span style="font-size: 1.5rem; color: #f59e0b;">⚡</span>
                        <span style="font-weight: 600;">Battery Power</span>
                    </span>
                    <span class="value" id="battery-power">--</span>
                </div>
                <div class="metric">
                    <span style="display: flex; align-items: center; gap: 0.75rem;">
                        <span style="font-size: 1.5rem; color: #10b981;">☀️</span>
                        <span style="font-weight: 600;">Solar Power</span>
                    </span>
                    <span class="value positive" id="pv-power">--</span>
                </div>
                <div class="metric" id="pv-strings" style="display: none; font-size: 0.8rem; color: #94a3b8; border-top: 1px solid #334155; padding-top: 0.5rem; margin-top: 0.5rem;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 0.5rem; text-align: center;">
                        <div id="pv1-details">PV1: <span id="pv1-power">--</span>W<br><span id="pv1-voltage">--</span>V</div>
                        <div id="pv2-details">PV2: <span id="pv2-power">--</span>W<br><span id="pv2-voltage">--</span>V</div>
                        <div id="pv3-details">PV3: <span id="pv3-power">--</span>W<br><span id="pv3-voltage">--</span>V</div>
                    </div>
                </div>
                <div class="metric">
                    <span style="display: flex; align-items: center; gap: 0.75rem;">
                        <span style="font-size: 1.5rem; color: #3b82f6;">🏠</span>
                        <span style="font-weight: 600;">Grid Power</span>
                    </span>
                    <span class="value" id="grid-power">--</span>
                </div>
                <div class="metric">
                    <span style="display: flex; align-items: center; gap: 0.75rem;">
                        <span style="font-size: 1.5rem; color: #8b5cf6;">⚡</span>
                        <span style="font-weight: 600;">Load Power</span>
                    </span>
                    <span class="value" id="load-power">--</span>
                </div>
                <div class="metric">
                    <span style="display: flex; align-items: center; gap: 0.75rem;">
                        <span style="font-size: 1.5rem; color: #10b981;">🔋</span>
                        <span style="font-weight: 600;">Battery Voltage</span>
                    </span>
                    <span class="value" id="battery-voltage">--</span>
                </div>
                <div class="metric">
                    <span style="display: flex; align-items: center; gap: 0.75rem;">
                        <span style="font-size: 1.5rem; color: #3b82f6;">⚡</span>
                        <span style="font-weight: 600;">Grid Voltage</span>
                    </span>
                    <span class="value" id="grid-voltage">--</span>
                </div>
                <div class="metric">
                    <span class="metric-label">
                        <span class="metric-icon" style="color: #06b6d4;">📡</span>
                        <span>Connection Status</span>
                    </span>
                    <span class="status-badge status-offline" id="eg4-status-badge">
                        <span class="status-indicator offline" id="eg4-status"></span>
                        <span id="eg4-status-text">Offline</span>
                    </span>
                </div>
            </div>
            
            <!-- Enphase Status -->
            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                    <div>
                        <h2 style="margin: 0;">Enphase Solar System</h2>
                        <div style="color: #64748b; font-size: 0.75rem; margin-top: 0.25rem;">
                            Last updated: <span id="enphase-last-update">--</span>
                        </div>
                    </div>
                </div>
                <div class="metric">
                    <span class="metric-label">
                        <span class="metric-icon" style="color: #f59e0b;">☀️</span>
                        <span>Current Power</span>
                    </span>
                    <span class="value positive" id="enphase-current-power">-- W</span>
                </div>
                <div class="metric">
                    <span class="metric-label">
                        <span class="metric-icon" style="color: #10b981;">🌅</span>
                        <span>Today's Energy</span>
                    </span>
                    <span class="value positive" id="enphase-today-energy">-- kWh</span>
                </div>
                <div class="metric">
                    <span class="metric-label">
                        <span class="metric-icon" style="color: #8b5cf6;">🌎</span>
                        <span>Lifetime Energy</span>
                    </span>
                    <span class="value" id="enphase-lifetime-energy">-- MWh</span>
                </div>
                <div class="metric">
                    <span class="metric-label">
                        <span class="metric-icon" style="color: #06b6d4;">🔌</span>
                        <span>AC Voltage</span>
                    </span>
                    <span class="value" id="enphase-microinverters">--</span>
                </div>
                <div class="metric">
                    <span class="metric-label">
                        <span class="metric-icon" style="color: #06b6d4;">📡</span>
                        <span>Connection Status</span>
                    </span>
                    <span class="status-badge status-offline" id="enphase-status-badge">
                        <span class="status-indicator offline" id="enphase-status"></span>
                        <span id="enphase-status-text">Offline</span>
                    </span>
                </div>
            </div>
            </div>
        </div>
        
        <!-- Moved to top of page -->
        </div>
        
        <!-- Alert Configuration Tab -->
        <div id="alerts-tab" class="tab-content">
            <div class="config-section">
            <h2 style="margin-bottom: 1.5rem;">Configuration</h2>
            
            <!-- Timezone Settings -->
            <div class="form-group" style="background: #334155; padding: 1rem; border-radius: 0.5rem; margin-bottom: 1.5rem;">
                <div style="display: flex; align-items: center; gap: 1rem;">
                    <label style="margin: 0; font-weight: bold; color: #f1f5f9;">Timezone:</label>
                    <select id="timezone-select" style="background: #1e293b; color: #e2e8f0; border: 1px solid #475569; padding: 0.5rem; border-radius: 0.25rem; cursor: pointer;">
                        <option value="UTC">UTC</option>
                        <option value="America/Phoenix" selected>Phoenix (MST)</option>
                        <option value="America/Los_Angeles">Los Angeles (PST/PDT)</option>
                        <option value="America/Denver">Denver (MST/MDT)</option>
                        <option value="America/Chicago">Chicago (CST/CDT)</option>
                        <option value="America/New_York">New York (EST/EDT)</option>
                    </select>
                    <span id="current-time" style="color: #94a3b8; font-size: 0.875rem;"></span>
                </div>
                <p style="margin: 0.5rem 0 0 0; color: #94a3b8; font-size: 0.75rem;">
                    All alert times use the selected timezone. Container will restart when timezone is changed.
                </p>
            </div>
            
            <!-- Credentials Section -->
            <div class="form-group" style="background: #334155; padding: 1.5rem; border-radius: 0.5rem; margin-bottom: 1.5rem;">
                <h3 style="margin: 0 0 1rem 0; color: #f1f5f9;">System Credentials</h3>
                <div class="grid" style="grid-template-columns: repeat(3, 1fr); gap: 1.5rem;">
                    <div>
                        <h4 style="margin: 0 0 0.5rem 0; color: #3b82f6;">EG4 Cloud Account</h4>
                        <div class="form-group">
                            <label>Username</label>
                            <input type="text" id="eg4-username" placeholder="Your EG4 username">
                        </div>
                        <div class="form-group">
                            <label>Password</label>
                            <input type="password" id="eg4-password" placeholder="Your EG4 password">
                        </div>
                    </div>
                    <div>
                        <h4 style="margin: 0 0 0.5rem 0; color: #3b82f6;">SRP Account</h4>
                        <div class="form-group">
                            <label>Username</label>
                            <input type="text" id="srp-username" placeholder="Your SRP username">
                        </div>
                        <div class="form-group">
                            <label>Password</label>
                            <input type="password" id="srp-password" placeholder="Your SRP password">
                        </div>
                    </div>
                    <div>
                        <h4 style="margin: 0 0 0.5rem 0; color: #3b82f6;">Enphase Account</h4>
                        <div class="form-group">
                            <label>Username</label>
                            <input type="text" id="enphase-username" placeholder="Your Enphase username">
                        </div>
                        <div class="form-group">
                            <label>Password</label>
                            <input type="password" id="enphase-password" placeholder="Your Enphase password">
                        </div>
                    </div>
                </div>
                <p style="margin: 1rem 0 0 0; color: #94a3b8; font-size: 0.75rem;">
                    <strong>Note:</strong> Credentials are securely stored and used only for data collection. 
                    EG4 credentials access your inverter cloud data, SRP credentials access your utility usage data.
                </p>
            </div>
            
            <div class="form-group">
                <div class="checkbox-group">
                    <input type="checkbox" id="email-enabled">
                    <label for="email-enabled" style="margin: 0;">Enable Email Alerts</label>
                </div>
            </div>
            
            <div class="grid">
                <div>
                    <h3 style="margin-bottom: 1rem; color: #f1f5f9;">Email Settings</h3>
                    <div class="form-group">
                        <label>Email Recipients (comma-separated)</label>
                        <input type="text" id="email-to" placeholder="user1@example.com, user2@example.com">
                    </div>
                    <div class="form-group" style="background: #334155; padding: 1rem; border-radius: 0.25rem;">
                        <p style="margin: 0; color: #94a3b8; font-size: 0.875rem;">
                            <strong>Gmail Status:</strong> <span id="gmail-status" style="color: #f59e0b;">Checking...</span>
                            <button id="configure-gmail-btn" class="link-button" style="margin-left: 1rem; display: none;" onclick="showGmailConfig()">Configure</button>
                        </p>
                        <p style="margin: 0.5rem 0 0 0; color: #94a3b8; font-size: 0.875rem;">
                            <strong>Note:</strong> Email alerts are sent via Gmail. Multiple recipients can be separated by commas.
                        </p>
                    </div>
                </div>
                
                <div>
                    <h3 style="margin-bottom: 1rem; color: #f1f5f9;">Alert Thresholds</h3>
                    
                    <!-- Battery Alerts -->
                    <div style="background: #0f172a; padding: 1rem; border-radius: 0.5rem; margin-bottom: 1rem;">
                        <h4 style="margin: 0 0 0.75rem 0; color: #94a3b8; font-size: 1rem;">Battery Alerts</h4>
                        <div class="threshold-grid">
                            <div class="form-group">
                                <label>Low Battery Threshold (%)</label>
                                <input type="number" id="battery-low" min="0" max="100" value="20">
                            </div>
                            <div class="form-group">
                                <label>Check Time (24h)</label>
                                <div style="display: flex; gap: 0.5rem;">
                                    <input type="number" id="battery-check-hour" min="0" max="23" value="6" style="width: 60px;" title="Hour">
                                    <span style="line-height: 2rem;">:</span>
                                    <input type="number" id="battery-check-minute" min="0" max="59" value="0" style="width: 60px;" title="Minute">
                                </div>
                            </div>
                        </div>
                        <p style="margin: 0.5rem 0 0 0; color: #64748b; font-size: 0.75rem;">
                            SOC is checked once daily at the specified time in your selected timezone. Alert sent if below threshold.
                        </p>
                    </div>
                    
                    <!-- Peak Demand Alerts -->
                    <div style="background: #0f172a; padding: 1rem; border-radius: 0.5rem; margin-bottom: 1rem;">
                        <h4 style="margin: 0 0 0.75rem 0; color: #94a3b8; font-size: 1rem;">Peak Demand Alerts</h4>
                        <div class="threshold-grid">
                            <div class="form-group">
                                <label>Peak Demand Threshold (kW)</label>
                                <input type="number" id="peak-demand-threshold" min="0" step="0.1" value="5.0">
                            </div>
                            <div class="form-group">
                                <label>Check Time (24h)</label>
                                <div style="display: flex; gap: 0.5rem;">
                                    <input type="number" id="peak-demand-check-hour" min="0" max="23" value="6" style="width: 60px;" title="Hour">
                                    <span style="line-height: 2rem;">:</span>
                                    <input type="number" id="peak-demand-check-minute" min="0" max="59" value="0" style="width: 60px;" title="Minute">
                                </div>
                            </div>
                        </div>
                        <p style="margin: 0.5rem 0 0 0; color: #64748b; font-size: 0.75rem;">
                            Peak demand is checked once daily at the specified time in your selected timezone. Alert sent if exceeds threshold.
                        </p>
                    </div>
                    
                    <!-- Grid Import Alerts -->
                    <div style="background: #0f172a; padding: 1rem; border-radius: 0.5rem; margin-bottom: 1rem;">
                        <h4 style="margin: 0 0 0.75rem 0; color: #94a3b8; font-size: 1rem;">Grid Import Alerts</h4>
                        <div class="threshold-grid">
                            <div class="form-group">
                                <label>Import Threshold (W)</label>
                                <input type="number" id="grid-import" min="0" value="10000">
                            </div>
                            <div class="form-group">
                                <label>Start Hour (24h)</label>
                                <input type="number" id="grid-import-start-hour" min="0" max="23" value="14" title="14 = 2:00 PM">
                            </div>
                            <div class="form-group">
                                <label>End Hour (24h)</label>
                                <input type="number" id="grid-import-end-hour" min="0" max="23" value="20" title="20 = 8:00 PM">
                            </div>
                        </div>
                        <p style="margin: 0.5rem 0 0 0; color: #64748b; font-size: 0.75rem;">
                            Only triggers during the specified hours when import exceeds threshold. Times in your selected timezone.
                        </p>
                    </div>
                </div>
            </div>
            
            <div style="display: flex; gap: 1rem; margin-top: 1.5rem;">
                <button onclick="saveConfig()">Save Configuration</button>
                <button onclick="testEmail()" style="background: #475569;">Test Email</button>
            </div>
            <div id="save-feedback" style="margin-top: 0.5rem; padding: 0.5rem 1rem; border-radius: 0.375rem; display: none;"></div>
            
            <!-- System Logs Section -->
            <div style="margin-top: 2rem; border-top: 1px solid #334155; padding-top: 2rem;">
                <h3 style="margin-bottom: 1rem; color: #f1f5f9;">System Logs</h3>
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                    <div style="display: flex; gap: 1rem; align-items: center;">
                        <select id="log-level" onchange="loadLogs()" style="background: #1e293b; color: #e2e8f0; border: 1px solid #475569; padding: 0.5rem; border-radius: 0.25rem;">
                            <option value="ALL">All Levels</option>
                            <option value="ERROR">Errors Only</option>
                            <option value="WARNING">Warnings & Errors</option>
                            <option value="INFO">Info & Above</option>
                        </select>
                        <button onclick="loadLogs()" style="background: #475569; padding: 0.5rem 1rem;">Refresh</button>
                    </div>
                    <div style="display: flex; gap: 0.5rem;">
                        <button onclick="clearLogs()" style="background: #dc2626; padding: 0.5rem 1rem;">Clear Buffer</button>
                        <button onclick="downloadLogs()" style="background: #059669; padding: 0.5rem 1rem;">Download Full Log</button>
                    </div>
                </div>
                <div id="log-info" style="margin-bottom: 0.5rem; color: #64748b; font-size: 0.875rem;"></div>
                <div id="log-container" style="background: #0f172a; border: 1px solid #334155; border-radius: 0.5rem; padding: 1rem; height: 400px; overflow-y: auto; font-family: monospace; font-size: 0.875rem; white-space: pre-wrap; word-wrap: break-word;">
                    <div style="color: #64748b; text-align: center; padding: 2rem;">Loading logs...</div>
                </div>
                <div style="margin-top: 0.5rem; color: #64748b; font-size: 0.75rem;">
                    <p>• Logs are rotated at 10MB with 3 backup files</p>
                    <p>• In-memory buffer holds last 1000 log entries</p>
                    <p>• Application logs: <code style="background: #334155; padding: 0.2rem 0.4rem; border-radius: 0.25rem;">tail -f logs/eg4_srp_monitor.log</code></p>
                </div>
            </div>
        </div>
    </div>
        </div>
    
    <!-- Gmail Configuration Modal -->
    <div id="gmail-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 style="margin: 0; color: #f1f5f9;">Configure Gmail</h2>
                <span class="close" onclick="closeGmailConfig()">&times;</span>
            </div>
            
            <div class="form-group">
                <label>Email Address</label>
                <input type="email" id="gmail-address" placeholder="your-email@domain.com">
                <p style="margin: 0.5rem 0 0 0; color: #94a3b8; font-size: 0.875rem;">
                    Works with Gmail and Google Workspace custom domains
                </p>
            </div>
            
            <div class="form-group">
                <label>Google App Password</label>
                <input type="password" id="gmail-app-password" placeholder="16-character app password">
                <p style="margin: 0.5rem 0 0 0; color: #94a3b8; font-size: 0.875rem;">
                    <a href="https://myaccount.google.com/apppasswords" target="_blank" style="color: #3b82f6;">
                        Create an App Password
                    </a> (not your regular password)
                </p>
            </div>
            
            <div id="gmail-config-error" style="display: none; background: #dc2626; color: white; padding: 0.5rem; border-radius: 0.25rem; margin-bottom: 1rem;"></div>
            
            <div style="background: #334155; padding: 1rem; border-radius: 0.25rem; margin-bottom: 1rem;">
                <p style="margin: 0 0 0.5rem 0; color: #f1f5f9; font-weight: bold;">Instructions:</p>
                <ol style="margin: 0; padding-left: 1.5rem; color: #94a3b8; font-size: 0.875rem;">
                    <li>Go to Google Account settings</li>
                    <li>Enable 2-Step Verification if not already enabled</li>
                    <li>Generate an App Password for "Mail"</li>
                    <li>Copy the 16-character password (without spaces)</li>
                    <li>Enter it above along with your email address</li>
                </ol>
            </div>
            
            <button onclick="configureGmail()" style="width: 100%;">Configure Gmail</button>
        </div>
    </div>
    
    <script>
        const socket = io();
        
        // Tab switching functionality
        function switchTab(tabName) {
            // Update active tab button
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Update active tab content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(tabName + '-tab').classList.add('active');
            
            // Load logs when switching to configuration/alerts tab
            if (tabName === 'alerts') {
                // Add small delay to ensure DOM is ready
                setTimeout(() => {
                    if (document.getElementById('log-level')) {
                        loadLogs();
                    }
                }, 100);
            }
        }
        
        // Update EG4 data
        socket.on('eg4_update', (data) => {
            const socElement = document.getElementById('battery-soc');
            socElement.textContent = data.battery.soc + '%';
            
            // Enhanced battery level styling
            let socClass = 'value ';
            if (data.battery.soc <= 15) {
                socClass += 'battery-critical';
            } else if (data.battery.soc <= 30) {
                socClass += 'battery-low';
            } else if (data.battery.soc >= 80) {
                socClass += 'battery-good';
            } else {
                socClass += 'warning';
            }
            socElement.className = socClass;
            
            document.getElementById('battery-power').textContent = data.battery.power + 'W';
            document.getElementById('battery-power').className = 'value ' + 
                (data.battery.power < 0 ? 'negative' : 'positive');
            
            // Update total PV power with enhanced styling
            const pvElement = document.getElementById('pv-power');
            pvElement.textContent = data.pv.power + 'W';
            pvElement.className = 'value positive';
            
            // Update individual PV string details if available
            if (data.pv.strings) {
                const strings = data.pv.strings;
                
                // Update PV1
                if (strings.pv1 && strings.pv1.power > 0) {
                    document.getElementById('pv1-power').textContent = strings.pv1.power;
                    document.getElementById('pv1-voltage').textContent = strings.pv1.voltage.toFixed(1);
                    document.getElementById('pv1-details').style.display = 'block';
                } else {
                    document.getElementById('pv1-details').style.display = 'none';
                }
                
                // Update PV2
                if (strings.pv2 && strings.pv2.power > 0) {
                    document.getElementById('pv2-power').textContent = strings.pv2.power;
                    document.getElementById('pv2-voltage').textContent = strings.pv2.voltage.toFixed(1);
                    document.getElementById('pv2-details').style.display = 'block';
                } else {
                    document.getElementById('pv2-details').style.display = 'none';
                }
                
                // Update PV3
                if (strings.pv3 && strings.pv3.power > 0) {
                    document.getElementById('pv3-power').textContent = strings.pv3.power;
                    document.getElementById('pv3-voltage').textContent = strings.pv3.voltage.toFixed(1);
                    document.getElementById('pv3-details').style.display = 'block';
                } else {
                    document.getElementById('pv3-details').style.display = 'none';
                }
                
                // Show the strings section if any string has power
                const anyStringActive = (strings.pv1?.power > 0) || (strings.pv2?.power > 0) || (strings.pv3?.power > 0);
                document.getElementById('pv-strings').style.display = anyStringActive ? 'block' : 'none';
            }
            const gridElement = document.getElementById('grid-power');
            gridElement.textContent = data.grid.power + 'W';
            // Grid power: positive = importing (red), negative = exporting (green)
            gridElement.className = 'value ' + (data.grid.power > 0 ? 'negative' : 'positive');
            
            document.getElementById('load-power').textContent = data.load.power + 'W';
            
            document.getElementById('battery-voltage').textContent = data.battery.voltage + 'V';
            document.getElementById('grid-voltage').textContent = data.grid.voltage + 'V';
            
            document.getElementById('eg4-status').className = 'status-indicator online';
            document.getElementById('eg4-status-text').textContent = 'Online';
            document.getElementById('eg4-status-badge').className = 'status-badge status-online';
            
            // Update last update time from data if available
            if (data.last_update) {
                const updateTime = new Date(data.last_update);
                document.getElementById('eg4-last-update').textContent = updateTime.toLocaleString();
            } else {
                const now = new Date();
                document.getElementById('eg4-last-update').textContent = now.toLocaleString();
            }
        });
        
        // Update SRP data
        socket.on('srp_update', (data) => {
            document.getElementById('peak-demand-header').textContent = data.demand.toFixed(1) + ' kW';
            
            // Use last_daily_update if available, otherwise use timestamp
            const timeField = data.last_daily_update || data.timestamp;
            
            // Update CSV data timestamp if available
            if (data.csv_last_update) {
                const csvTime = new Date(data.csv_last_update);
                document.getElementById('chart-last-update').textContent = csvTime.toLocaleString();
            }
            
            // Log debug info if available
            if (data.debug) {
                console.log('SRP debug info:', data.debug);
            }
        });
        
        // Update Enphase data
        socket.on('enphase_update', (data) => {
            document.getElementById('enphase-current-power').textContent = (data.latest_power_w || 0) + ' W';
            document.getElementById('enphase-today-energy').textContent = (data.today_energy_kwh || 0).toFixed(2) + ' kWh';
            document.getElementById('enphase-lifetime-energy').textContent = (data.lifetime_mwh || 0).toFixed(2) + ' MWh';
            // Use AC voltage instead of microinverter count which isn't available
            document.getElementById('enphase-microinverters').textContent = data.microinverter_ac_voltage_v ? 'AC: ' + data.microinverter_ac_voltage_v.toFixed(1) + 'V' : '--';
            
            // Update timestamp
            if (data.timestamp) {
                const updateTime = new Date(data.timestamp);
                document.getElementById('enphase-last-update').textContent = updateTime.toLocaleString();
            }
            
            document.getElementById('enphase-status').className = 'status-indicator online';
            document.getElementById('enphase-status-text').textContent = 'Online';
            document.getElementById('enphase-status-badge').className = 'status-badge status-online';
        });
        
        // Handle alerts
        socket.on('alert', (data) => {
            const alertDiv = document.getElementById('alert');
            alertDiv.style.display = 'block';
            alertDiv.innerHTML = `<strong>${data.subject}:</strong> ${data.message}`;
            
            setTimeout(() => {
                alertDiv.style.display = 'none';
            }, 10000);
        });
        
        // Load configuration
        async function loadConfig() {
            const response = await fetch('/api/config');
            const config = await response.json();
            
            document.getElementById('email-enabled').checked = config.email_enabled;
            document.getElementById('email-to').value = config.email_to || '';
            
            document.getElementById('battery-low').value = config.thresholds.battery_low;
            document.getElementById('battery-check-hour').value = config.thresholds.battery_check_hour || 6;
            document.getElementById('battery-check-minute').value = config.thresholds.battery_check_minute || 0;
            document.getElementById('peak-demand-threshold').value = config.thresholds.peak_demand;
            document.getElementById('peak-demand-check-hour').value = config.thresholds.peak_demand_check_hour || 6;
            document.getElementById('peak-demand-check-minute').value = config.thresholds.peak_demand_check_minute || 0;
            document.getElementById('grid-import').value = config.thresholds.grid_import;
            document.getElementById('grid-import-start-hour').value = config.thresholds.grid_import_start_hour || 14;
            document.getElementById('grid-import-end-hour').value = config.thresholds.grid_import_end_hour || 20;
            
            // Set timezone
            if (config.timezone) {
                document.getElementById('timezone-select').value = config.timezone;
            }
            
            // Load credentials
            if (config.credentials) {
                document.getElementById('eg4-username').value = config.credentials.eg4_username || '';
                document.getElementById('eg4-password').value = config.credentials.eg4_password || '';
                document.getElementById('srp-username').value = config.credentials.srp_username || '';
                document.getElementById('srp-password').value = config.credentials.srp_password || '';
                document.getElementById('enphase-username').value = config.credentials.enphase_username || '';
                document.getElementById('enphase-password').value = config.credentials.enphase_password || '';
            }
            
            // Update SRP next update display
            updateSRPNextUpdate();
        }
        
        // Save configuration
        async function saveConfig() {
            const feedbackEl = document.getElementById('save-feedback');
            
            // Show saving message
            feedbackEl.style.display = 'block';
            feedbackEl.style.background = '#3b82f6';
            feedbackEl.style.color = '#ffffff';
            feedbackEl.textContent = 'Saving configuration...';
            
            const config = {
                email_enabled: document.getElementById('email-enabled').checked,
                email_to: document.getElementById('email-to').value,
                timezone: document.getElementById('timezone-select').value,
                credentials: {
                    eg4_username: document.getElementById('eg4-username').value,
                    eg4_password: document.getElementById('eg4-password').value,
                    srp_username: document.getElementById('srp-username').value,
                    srp_password: document.getElementById('srp-password').value,
                    enphase_username: document.getElementById('enphase-username').value,
                    enphase_password: document.getElementById('enphase-password').value
                },
                thresholds: {
                    battery_low: parseInt(document.getElementById('battery-low').value),
                    battery_check_hour: parseInt(document.getElementById('battery-check-hour').value),
                    battery_check_minute: parseInt(document.getElementById('battery-check-minute').value),
                    peak_demand: parseFloat(document.getElementById('peak-demand-threshold').value),
                    peak_demand_check_hour: parseInt(document.getElementById('peak-demand-check-hour').value),
                    peak_demand_check_minute: parseInt(document.getElementById('peak-demand-check-minute').value),
                    grid_import: parseInt(document.getElementById('grid-import').value),
                    grid_import_start_hour: parseInt(document.getElementById('grid-import-start-hour').value),
                    grid_import_end_hour: parseInt(document.getElementById('grid-import-end-hour').value)
                }
            };
            
            try {
                const response = await fetch('/api/config', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(config)
                });
                
                if (response.ok) {
                    // Show success feedback
                    feedbackEl.style.display = 'none';
                    showToast('Configuration saved successfully!', 'success');
                    
                    // If credentials were updated, restart monitoring
                    if (config.credentials.eg4_username || config.credentials.eg4_password || 
                        config.credentials.srp_username || config.credentials.srp_password) {
                        // Trigger a manual refresh to use new credentials
                        setTimeout(() => {
                            fetch('/api/refresh', { method: 'POST' })
                                .then(() => console.log('Triggered manual refresh with new credentials'));
                        }, 1000);
                    }
                } else {
                    // Show error feedback
                    const error = await response.json();
                    feedbackEl.style.display = 'none';
                    showToast('Failed to save: ' + (error.message || 'Unknown error'), 'error');
                }
            } catch (error) {
                // Show error feedback
                feedbackEl.style.display = 'none';
                showToast('Failed to save: ' + error.message, 'error');
            }
        }
        
        // Test email
        async function testEmail() {
            const button = event.target;
            const originalText = button.textContent;
            button.disabled = true;
            button.textContent = 'Sending...';
            
            try {
                const response = await fetch('/api/test-email');
                const result = await response.json();
                
                if (response.ok) {
                    showToast('Test email sent! Check your inbox.', 'success');
                } else {
                    // Show detailed error message
                    let errorMsg = result.message || 'Failed to send test email';
                    
                    // If gmail is not configured, offer to configure it
                    if (result.gmail_configured === false) {
                        showToast(errorMsg, 'error', 5000);
                        setTimeout(() => {
                            if (confirm('Gmail is not configured.\n\nWould you like to configure Gmail now?')) {
                                showGmailConfig();
                            }
                        }, 1000);
                    } else {
                        showToast(errorMsg, 'error');
                    }
                }
            } catch (error) {
                showToast('Error sending test email: ' + error.message, 'error');
            } finally {
                button.disabled = false;
                button.textContent = originalText;
            }
        }
        
        // Show Gmail configuration modal
        function showGmailConfig() {
            document.getElementById('gmail-modal').style.display = 'block';
            document.getElementById('gmail-config-error').style.display = 'none';
        }
        
        // Close Gmail configuration modal
        function closeGmailConfig() {
            document.getElementById('gmail-modal').style.display = 'none';
            document.getElementById('gmail-address').value = '';
            document.getElementById('gmail-app-password').value = '';
            document.getElementById('gmail-config-error').style.display = 'none';
        }
        
        // Configure Gmail
        async function configureGmail() {
            const email = document.getElementById('gmail-address').value.trim();
            const password = document.getElementById('gmail-app-password').value.trim();
            const errorDiv = document.getElementById('gmail-config-error');
            
            if (!email) {
                errorDiv.textContent = 'Please enter your Gmail address';
                errorDiv.style.display = 'block';
                return;
            }
            
            if (!password) {
                errorDiv.textContent = 'Please enter your Gmail app password';
                errorDiv.style.display = 'block';
                return;
            }
            
            // Disable button while configuring
            const button = event.target;
            button.disabled = true;
            button.textContent = 'Configuring...';
            
            try {
                const response = await fetch('/api/configure-gmail', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        email_address: email,
                        app_password: password
                    })
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    alert(result.message);
                    closeGmailConfig();
                    checkGmailStatus();
                } else {
                    errorDiv.textContent = result.message;
                    errorDiv.style.display = 'block';
                }
            } catch (error) {
                errorDiv.textContent = 'Error configuring Gmail: ' + error.message;
                errorDiv.style.display = 'block';
            } finally {
                button.disabled = false;
                button.textContent = 'Configure Gmail';
            }
        }
        
        // Check Gmail status
        async function checkGmailStatus() {
            try {
                const response = await fetch('/api/gmail-status');
                const data = await response.json();
                const statusEl = document.getElementById('gmail-status');
                
                if (data.configured) {
                    statusEl.textContent = 'Configured ✓';
                    statusEl.style.color = '#22c55e';
                    document.getElementById('configure-gmail-btn').style.display = 'none';
                } else {
                    statusEl.textContent = 'Not configured ✗';
                    statusEl.style.color = '#ef4444';
                    statusEl.title = data.message;
                    document.getElementById('configure-gmail-btn').style.display = 'inline';
                }
            } catch (error) {
                const statusEl = document.getElementById('gmail-status');
                statusEl.textContent = 'Error checking status';
                statusEl.style.color = '#ef4444';
            }
        }
        
        // Refresh EG4 data manually
        async function refreshEG4(event = null) {
            let button = null;
            if (event && event.target) {
                button = event.target;
                button.disabled = true;
                button.textContent = 'Refreshing...';
            }
            
            try {
                const response = await fetch('/api/refresh-eg4', { method: 'POST' });
                const result = await response.json();
                
                if (response.ok) {
                    showToast('Data refreshed successfully', 'success');
                } else {
                    showToast('Failed to refresh: ' + (result.message || 'Unknown error'), 'error');
                }
            } catch (error) {
                showToast('Error refreshing data: ' + error.message, 'error');
            } finally {
                if (button) {
                    button.disabled = false;
                    button.textContent = 'Refresh Now';
                }
            }
        }
        
        // Update current time display
        function updateCurrentTime() {
            const now = new Date();
            const timeStr = now.toLocaleTimeString('en-US', {
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                hour12: false
            });
            const dateStr = now.toLocaleDateString('en-US', {
                weekday: 'short',
                month: 'short',
                day: 'numeric'
            });
            document.getElementById('current-time').textContent = `Current time: ${dateStr} ${timeStr}`;
        }
        
        // Handle timezone change
        async function handleTimezoneChange() {
            const timezone = document.getElementById('timezone-select').value;
            
            // Save configuration first
            await saveConfig();
            
            // Show notification about container restart
            if (confirm('Changing timezone requires a container restart. The application will be unavailable for about 30 seconds. Continue?')) {
                // Update timezone on server
                const response = await fetch('/api/timezone', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ timezone })
                });
                
                if (response.ok) {
                    alert('Timezone updated. The container is restarting...');
                    // Reload page after delay
                    setTimeout(() => {
                        window.location.reload();
                    }, 5000);
                } else {
                    alert('Failed to update timezone');
                    // Reload config to restore previous value
                    loadConfig();
                }
            } else {
                // Restore previous value
                loadConfig();
            }
        }
        
        // Set up timezone change handler
        document.getElementById('timezone-select').addEventListener('change', handleTimezoneChange);
        
        // Update time every second
        setInterval(updateCurrentTime, 1000);
        updateCurrentTime();
        
        // Log functions
        async function loadLogs() {
            const levelElement = document.getElementById('log-level');
            if (!levelElement) {
                console.warn('Log level element not found, skipping log load');
                return; // Exit if element doesn't exist
            }
            
            const level = levelElement.value || 'ALL';
            const lines = 100; // Default to 100 lines
            
            try {
                const response = await fetch(`/api/logs?level=${level}&lines=${lines}`);
                const data = await response.json();
                
                // Update log info
                document.getElementById('log-info').innerHTML = 
                    `Showing ${data.logs.length} of ${data.total_buffered} buffered entries | ` +
                    `Log file: ${data.log_file} (Max: ${data.max_size_mb}MB, Rotations: ${data.rotation_count})`;
                
                // Display logs
                const container = document.getElementById('log-container');
                if (data.logs.length === 0) {
                    container.innerHTML = '<div style="color: #64748b; text-align: center; padding: 2rem;">No logs matching criteria</div>';
                } else {
                    container.innerHTML = data.logs.map(log => {
                        const levelColor = {
                            'ERROR': '#ef4444',
                            'WARNING': '#f59e0b',
                            'INFO': '#3b82f6',
                            'DEBUG': '#8b5cf6'
                        }[log.level] || '#94a3b8';
                        
                        // Format timestamp
                        const date = new Date(log.timestamp * 1000);
                        const timeStr = date.toLocaleString();
                        
                        return `<div style="margin-bottom: 0.5rem;"><span style="color: ${levelColor};">${log.message}</span></div>`;
                    }).join('');
                    
                    // Scroll to bottom
                    container.scrollTop = container.scrollHeight;
                }
            } catch (error) {
                console.error('Failed to load logs:', error);
                document.getElementById('log-container').innerHTML = 
                    '<div style="color: #ef4444; text-align: center; padding: 2rem;">Failed to load logs</div>';
            }
        }
        
        async function clearLogs() {
            if (!confirm('Clear the in-memory log buffer? This will not affect the log file.')) {
                return;
            }
            
            try {
                const response = await fetch('/api/logs/clear', { method: 'POST' });
                if (response.ok) {
                    loadLogs();
                } else {
                    alert('Failed to clear logs');
                }
            } catch (error) {
                console.error('Failed to clear logs:', error);
                alert('Failed to clear logs');
            }
        }
        
        async function downloadLogs() {
            try {
                const response = await fetch('/api/logs/download');
                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = response.headers.get('content-disposition').split('filename=')[1];
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                } else {
                    alert('Failed to download logs');
                }
            } catch (error) {
                console.error('Failed to download logs:', error);
                alert('Failed to download logs');
            }
        }
        
        // Load initial data
        loadConfig();
        checkGmailStatus();
        
        // Auto-refresh logs every 5 seconds when on configuration tab
        let logRefreshInterval = null;
        function startLogRefresh() {
            // Load logs immediately if on configuration tab
            if (document.getElementById('alerts-tab').classList.contains('active') && 
                document.getElementById('log-level')) {
                loadLogs();
            }
            
            if (logRefreshInterval) clearInterval(logRefreshInterval);
            logRefreshInterval = setInterval(() => {
                if (document.getElementById('alerts-tab').classList.contains('active') && 
                    document.getElementById('log-level')) {
                    loadLogs();
                }
            }, 5000);
        }
        startLogRefresh();
        
        // Auto-refresh functionality
        let autoRefreshInterval = null;
        
        function setupAutoRefresh() {
            const isEnabled = document.getElementById('auto-refresh').checked;
            const interval = parseInt(document.getElementById('refresh-interval').value) * 1000;
            
            // Clear existing interval
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
                autoRefreshInterval = null;
            }
            
            // Set up new interval if enabled
            if (isEnabled) {
                autoRefreshInterval = setInterval(() => {
                    refreshEG4(null); // Pass null for auto-refresh (no button to disable)
                }, interval);
            }
        }
        
        // Update SRP next update time
        function updateSRPNextUpdate() {
            const hour = parseInt(document.getElementById('peak-demand-check-hour').value) || 6;
            const minute = parseInt(document.getElementById('peak-demand-check-minute').value) || 0;
            
            // Update display time
            const timeStr = `${hour.toString().padStart(2, '0')}:${minute.toString().padStart(2, '0')}`;
            
            // Calculate next update
            const now = new Date();
            const nextUpdate = new Date();
            nextUpdate.setHours(hour, minute, 0, 0);
            
            // If time has passed today, set for tomorrow
            if (nextUpdate <= now) {
                nextUpdate.setDate(nextUpdate.getDate() + 1);
            }
            
            // Format next update time
            const options = { 
                weekday: 'short', 
                month: 'short', 
                day: 'numeric', 
                hour: '2-digit', 
                minute: '2-digit' 
            };
        }
        
        // Set up auto-refresh handlers
        document.getElementById('auto-refresh').addEventListener('change', setupAutoRefresh);
        document.getElementById('refresh-interval').addEventListener('change', setupAutoRefresh);
        
        // Update SRP time when config changes
        document.getElementById('peak-demand-check-hour').addEventListener('change', updateSRPNextUpdate);
        document.getElementById('peak-demand-check-minute').addEventListener('change', updateSRPNextUpdate);
        
        // Initialize auto-refresh
        setupAutoRefresh();
        updateSRPNextUpdate();
        
        // SRP Chart functionality
        let srpChart = null;
        let currentChartType = 'net';
        
        function switchChartType(chartType) {
            // Update active button
            document.querySelectorAll('.chart-type-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`[data-chart-type="${chartType}"]`).classList.add('active');
            
            // Update current chart type and reload
            currentChartType = chartType;
            
            // Update chart info text
            const chartInfo = document.getElementById('chart-info');
            switch(chartType) {
                case 'net':
                    chartInfo.innerHTML = `
                        <p style="margin: 0;">• Blue bars: Off-peak usage | Red bars: On-peak usage</p>
                        <p style="margin: 0;">• Lines: High/Low temperatures</p>
                        <p style="margin: 0;">• Negative values indicate energy export to grid</p>
                    `;
                    break;
                case 'generation':
                    chartInfo.innerHTML = `
                        <p style="margin: 0;">• Green bars: Solar generation</p>
                        <p style="margin: 0;">• Red bars: Energy consumption</p>
                        <p style="margin: 0;">• Compare your solar production to usage</p>
                    `;
                    break;
                case 'usage':
                    chartInfo.innerHTML = `
                        <p style="margin: 0;">• Blue bars: Off-peak usage | Red bars: On-peak usage</p>
                        <p style="margin: 0;">• Shows total energy consumption from grid</p>
                        <p style="margin: 0;">• Positive values only (no export shown)</p>
                    `;
                    break;
                case 'demand':
                    chartInfo.innerHTML = `
                        <p style="margin: 0;">• Orange bars: Peak demand in kW</p>
                        <p style="margin: 0;">• Shows highest power draw for each day</p>
                        <p style="margin: 0;">• Important for demand-based billing plans</p>
                    `;
                    break;
            }
            
            loadSRPChart();
        }
        
        async function loadSRPChart() {
            try {
                const response = await fetch(`/api/srp-chart-data?type=${currentChartType}`);
                if (!response.ok) {
                    throw new Error('Failed to load chart data');
                }
                
                const data = await response.json();
                
                // Create chart configuration based on chart type
                let datasets = [];
                let chartTitle = '';
                let yAxisTitle = 'Energy (kWh)';
                let stackedY = false;
                
                if (data.chartType === 'net' || data.chartType === 'usage') {
                    // Net energy and Usage charts
                    chartTitle = data.chartType === 'net' ? 'Net Energy' : 'Energy Usage';
                    stackedY = true;
                    datasets = [
                        {
                            label: 'Off-Peak kWh',
                            data: data.offPeak,
                            backgroundColor: 'rgba(59, 130, 246, 0.8)', // Blue
                            borderColor: 'rgba(59, 130, 246, 1)',
                            borderWidth: 1,
                            order: 2
                        },
                        {
                            label: 'On-Peak kWh',
                            data: data.onPeak,
                            backgroundColor: 'rgba(239, 68, 68, 0.8)', // Red
                            borderColor: 'rgba(239, 68, 68, 1)',
                            borderWidth: 1,
                            order: 2
                        }
                    ];
                    
                    // Add temperature lines if available
                    if (data.highTemp && data.highTemp.length > 0) {
                        datasets.push(
                            {
                                label: 'High Temp (°F)',
                                data: data.highTemp,
                                type: 'line',
                                borderColor: 'rgba(251, 191, 36, 0.8)', // Amber
                                backgroundColor: 'transparent',
                                borderWidth: 2,
                                pointRadius: 3,
                                yAxisID: 'y1',
                                order: 1
                            },
                            {
                                label: 'Low Temp (°F)',
                                data: data.lowTemp,
                                type: 'line',
                                borderColor: 'rgba(147, 197, 253, 0.8)', // Light blue
                                backgroundColor: 'transparent',
                                borderWidth: 2,
                                pointRadius: 3,
                                yAxisID: 'y1',
                                order: 1
                            }
                        );
                    }
                } else if (data.chartType === 'generation') {
                    // Generation chart
                    chartTitle = 'Solar Generation vs Consumption';
                    datasets = [
                        {
                            label: 'Solar Generation (kWh)',
                            data: data.generation,
                            backgroundColor: 'rgba(34, 197, 94, 0.8)', // Green
                            borderColor: 'rgba(34, 197, 94, 1)',
                            borderWidth: 1
                        },
                        {
                            label: 'Consumption (kWh)',
                            data: data.consumption,
                            backgroundColor: 'rgba(239, 68, 68, 0.8)', // Red
                            borderColor: 'rgba(239, 68, 68, 1)',
                            borderWidth: 1
                        }
                    ];
                } else if (data.chartType === 'demand') {
                    // Demand chart
                    chartTitle = 'Peak Demand';
                    yAxisTitle = 'Demand (kW)';
                    datasets = [
                        {
                            label: 'Peak Demand (kW)',
                            data: data.demand,
                            backgroundColor: 'rgba(251, 146, 60, 0.8)', // Orange
                            borderColor: 'rgba(251, 146, 60, 1)',
                            borderWidth: 1
                        }
                    ];
                }
                
                const config = {
                    type: 'bar',
                    data: {
                        labels: data.labels,
                        datasets: datasets
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: {
                            mode: 'index',
                            intersect: false
                        },
                        plugins: {
                            title: {
                                display: true,
                                text: chartTitle,
                                color: '#e2e8f0',
                                font: {
                                    size: 16
                                }
                            },
                            legend: {
                                labels: {
                                    color: '#e2e8f0'
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        let label = context.dataset.label || '';
                                        if (label) {
                                            label += ': ';
                                        }
                                        if (context.parsed.y !== null) {
                                            if (label.includes('Temp')) {
                                                label += context.parsed.y + '°F';
                                            } else {
                                                label += context.parsed.y + ' kWh';
                                            }
                                        }
                                        return label;
                                    }
                                }
                            }
                        },
                        scales: {
                            x: {
                                stacked: stackedY,
                                grid: {
                                    color: 'rgba(51, 65, 85, 0.5)'
                                },
                                ticks: {
                                    color: '#94a3b8'
                                }
                            },
                            y: {
                                stacked: stackedY,
                                position: 'left',
                                title: {
                                    display: true,
                                    text: yAxisTitle,
                                    color: '#e2e8f0'
                                },
                                grid: {
                                    color: 'rgba(51, 65, 85, 0.5)'
                                },
                                ticks: {
                                    color: '#94a3b8'
                                }
                            }
                        }
                    }
                };
                
                // Only add temperature Y-axis if we have temperature data
                if ((data.chartType === 'net' || data.chartType === 'usage') && data.highTemp && data.highTemp.length > 0) {
                    config.options.scales.y1 = {
                        position: 'right',
                        title: {
                            display: true,
                            text: 'Temperature (°F)',
                            color: '#e2e8f0'
                        },
                        grid: {
                            drawOnChartArea: false
                        },
                        ticks: {
                            color: '#94a3b8'
                        }
                    };
                }
                
                // Destroy existing chart if it exists
                if (srpChart) {
                    srpChart.destroy();
                }
                
                // Create new chart
                const ctx = document.getElementById('srpChart').getContext('2d');
                srpChart = new Chart(ctx, config);
                
                // Don't update timestamp here - let it come from the server
                
            } catch (error) {
                console.error('Failed to load SRP chart:', error);
                // Show error message in chart area
                const canvas = document.getElementById('srpChart');
                const ctx = canvas.getContext('2d');
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.fillStyle = '#94a3b8';
                ctx.font = '16px sans-serif';
                ctx.textAlign = 'center';
                
                // Check if this is a 404 with needsDownload flag
                if (error.message.includes('Failed to load chart data')) {
                    ctx.fillText(`No ${currentChartType} data available. Data will be downloaded at next scheduled update.`, canvas.width / 2, canvas.height / 2 - 10);
                    ctx.fillText(`You can also download manually using the button above.`, canvas.width / 2, canvas.height / 2 + 10);
                    
                    // Add download button functionality if needed
                    const refreshBtn = document.querySelector('button[onclick="loadSRPChart()"]');
                    if (refreshBtn && !refreshBtn.hasAttribute('data-download-enabled')) {
                        refreshBtn.setAttribute('data-download-enabled', 'true');
                        refreshBtn.textContent = 'Download & Refresh';
                        refreshBtn.onclick = async function() {
                            refreshBtn.disabled = true;
                            refreshBtn.textContent = 'Downloading...';
                            try {
                                const response = await fetch('/api/refresh-srp', {
                                    method: 'POST',
                                    headers: {'Content-Type': 'application/json'},
                                    body: JSON.stringify({download_csv: true})
                                });
                                if (response.ok) {
                                    refreshBtn.textContent = 'Loading Chart...';
                                    setTimeout(() => {
                                        loadSRPChart();
                                        refreshBtn.textContent = 'Refresh Chart';
                                        refreshBtn.disabled = false;
                                    }, 2000);
                                } else {
                                    throw new Error('Download failed');
                                }
                            } catch (err) {
                                alert('Failed to download data: ' + err.message);
                                refreshBtn.textContent = 'Download & Refresh';
                                refreshBtn.disabled = false;
                            }
                        };
                    }
                } else {
                    ctx.fillText(`Error loading ${currentChartType} data. Check console for details.`, canvas.width / 2, canvas.height / 2);
                }
            }
        }
        
        // Load chart when page loads
        loadSRPChart();
        
        // Load current status
        fetch('/api/status').then(r => r.json()).then(data => {
            if (data.eg4) {
                // Directly update UI for EG4
                const eg4Data = data.eg4;
                document.getElementById('battery-soc').textContent = eg4Data.battery.soc + '%';
                document.getElementById('battery-soc').className = 'value ' + 
                    (eg4Data.battery.soc < 20 ? 'negative' : eg4Data.battery.soc > 95 ? 'warning' : '');
                
                document.getElementById('battery-power').textContent = eg4Data.battery.power + 'W';
                document.getElementById('battery-power').className = 'value ' + 
                    (eg4Data.battery.power < 0 ? 'negative' : 'positive');
                
                document.getElementById('pv-power').textContent = eg4Data.pv.power + 'W';
                document.getElementById('grid-power').textContent = eg4Data.grid.power + 'W';
                document.getElementById('grid-power').className = 'value ' + 
                    (eg4Data.grid.power < 0 ? 'negative' : eg4Data.grid.power > 0 ? 'warning' : '');
                
                document.getElementById('load-power').textContent = eg4Data.load.power + 'W';
                document.getElementById('battery-voltage').textContent = eg4Data.battery.voltage + 'V';
                document.getElementById('grid-voltage').textContent = eg4Data.grid.voltage + 'V';
                
                document.getElementById('eg4-status').className = 'status-indicator online';
                document.getElementById('eg4-status-text').textContent = 'Online';
                document.getElementById('eg4-status-badge').className = 'status-badge status-online';
                
                if (eg4Data.last_update) {
                    const updateTime = new Date(eg4Data.last_update);
                    document.getElementById('eg4-last-update').textContent = updateTime.toLocaleString();
                }
            }
            if (data.srp) {
                // Directly update UI
                document.getElementById('peak-demand-header').textContent = data.srp.demand.toFixed(1) + ' kW';
            }
            if (data.enphase) {
                // Update Enphase UI
                document.getElementById('enphase-current-power').textContent = (data.enphase.latest_power_w || 0) + ' W';
                document.getElementById('enphase-today-energy').textContent = (data.enphase.today_energy_kwh || 0).toFixed(2) + ' kWh';
                document.getElementById('enphase-lifetime-energy').textContent = (data.enphase.lifetime_mwh || 0).toFixed(2) + ' MWh';
                // Microinverters not available in current data, hide or show placeholder
                document.getElementById('enphase-microinverters').textContent = data.enphase.microinverter_ac_voltage_v ? 'AC: ' + data.enphase.microinverter_ac_voltage_v.toFixed(1) + 'V' : '--';
                if (data.enphase.timestamp) {
                    const updateTime = new Date(data.enphase.timestamp);
                    document.getElementById('enphase-last-update').textContent = updateTime.toLocaleString();
                }
                document.getElementById('enphase-status').className = 'status-indicator online';
                document.getElementById('enphase-status-text').textContent = 'Online';
                document.getElementById('enphase-status-badge').className = 'status-badge status-online';
            }
        });
        
        // Close modal when clicking outside of it
        window.onclick = function(event) {
            const modal = document.getElementById('gmail-modal');
            if (event.target == modal) {
                closeGmailConfig();
            }
        };
        
        // Enhanced UX Functions
        function showToast(message, type = 'success', duration = 3000) {
            // Remove existing toasts
            const existingToasts = document.querySelectorAll('.toast');
            existingToasts.forEach(toast => toast.remove());
            
            // Create new toast
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            
            // Add to DOM
            document.body.appendChild(toast);
            
            // Show with animation
            setTimeout(() => toast.classList.add('show'), 100);
            
            // Auto remove
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 300);
            }, duration);
        }
        
        function addLoadingState(element) {
            if (element) {
                element.classList.add('loading');
            }
        }
        
        function removeLoadingState(element) {
            if (element) {
                element.classList.remove('loading');
            }
        }
        
        function animateValueChange(element, newValue) {
            if (element && element.textContent !== newValue) {
                element.classList.add('updating');
                setTimeout(() => {
                    element.textContent = newValue;
                    element.classList.remove('updating');
                }, 150);
            }
        }
        
        // Enhance existing socket handlers with animations
        const originalSocket = socket;
        
        // Override the EG4 data update handler to include animations
        socket.on('eg4_data', function(data) {
            // Add smooth animations for value updates
            const metrics = {
                'battery-soc': data.battery_soc + '%',
                'battery-power': data.battery_power + 'W',
                'pv-power': data.pv_power + 'W',
                'grid-power': data.grid_power + 'W',
                'load-power': data.load_power + 'W',
                'battery-voltage': data.battery_voltage + 'V',
                'grid-voltage': data.grid_voltage + 'V'
            };
            
            // Animate value changes
            Object.entries(metrics).forEach(([id, value]) => {
                const element = document.getElementById(id);
                if (element) {
                    animateValueChange(element, value);
                }
            });
            
            // Update PV details with animation
            if (data.pv1_power !== undefined) {
                animateValueChange(document.getElementById('pv1-power'), data.pv1_power);
                animateValueChange(document.getElementById('pv1-voltage'), data.pv1_voltage);
            }
            if (data.pv2_power !== undefined) {
                animateValueChange(document.getElementById('pv2-power'), data.pv2_power);
                animateValueChange(document.getElementById('pv2-voltage'), data.pv2_voltage);
            }
            if (data.pv3_power !== undefined) {
                animateValueChange(document.getElementById('pv3-power'), data.pv3_power);
                animateValueChange(document.getElementById('pv3-voltage'), data.pv3_voltage);
            }
            
            // Update timestamp
            document.getElementById('last-updated').textContent = new Date().toLocaleString();
            
            // Set status
            const statusElement = document.getElementById('status');
            if (statusElement) {
                statusElement.innerHTML = '<span style="color: #22c55e;">● Online</span>';
            }
        });
    </script>
</body>
</html>