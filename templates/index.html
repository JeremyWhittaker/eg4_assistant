<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EG4-SRP Monitor</title>
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Inter', sans-serif;
            background-color: #0f172a;
            background-image: radial-gradient(circle at 1px 1px, rgba(255,255,255,0.15) 1px, transparent 0);
            background-size: 20px 20px;
            color: #e2e8f0;
            padding: clamp(1rem, 4vw, 2rem);
            line-height: 1.6;
            letter-spacing: -0.025em;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        h1 {
            text-align: center;
            margin-bottom: clamp(1.5rem, 3vw, 3rem);
            color: #f1f5f9;
            font-size: clamp(1.75rem, 4vw, 2.5rem);
            font-weight: 700;
            letter-spacing: -0.05em;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }
        
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: clamp(1rem, 2vw, 2rem);
            margin-bottom: clamp(1.5rem, 3vw, 2.5rem);
        }
        
        .card {
            background: linear-gradient(145deg, #1e293b, #1a2332);
            border: 1px solid #334155;
            border-radius: 1rem;
            padding: clamp(1.25rem, 3vw, 2rem);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        
        .card h2 {
            margin-bottom: 1.5rem;
            color: #60a5fa;
            font-size: clamp(1.125rem, 2.5vw, 1.375rem);
            font-weight: 600;
            letter-spacing: -0.025em;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        
        .card h2::before {
            content: '';
            width: 4px;
            height: 1.5rem;
            background: linear-gradient(to bottom, #60a5fa, #3b82f6);
            border-radius: 2px;
        }
        
        .metric {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding: 0.875rem 0;
            border-bottom: 1px solid rgba(51, 65, 85, 0.5);
            font-size: 0.95rem;
        }
        
        .metric:last-child {
            border-bottom: none;
        }
        
        .value {
            font-weight: 700;
            color: #f1f5f9;
            font-size: 1.05rem;
            letter-spacing: -0.025em;
            font-variant-numeric: tabular-nums;
        }
        
        .positive { color: #22c55e; }
        .negative { color: #ef4444; }
        .warning { color: #f59e0b; }
        
        /* Loading States and Animations */
        .loading {
            position: relative;
            overflow: hidden;
        }
        
        .loading::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
            animation: shimmer 1.5s infinite;
        }
        
        @keyframes shimmer {
            0% { left: -100%; }
            100% { left: 100%; }
        }
        
        .skeleton {
            background: linear-gradient(90deg, #334155 25%, #475569 50%, #334155 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
            border-radius: 0.25rem;
        }
        
        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
        
        /* Enhanced Button Styles */
        button {
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }
        
        button:hover:not(:disabled) {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }
        
        button:active:not(:disabled) {
            transform: translateY(0);
        }
        
        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        /* Enhanced Card Styles */
        .card {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            backdrop-filter: blur(10px);
            position: relative;
        }
        
        .card:hover {
            border-color: #475569;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }
        
        /* Smooth Transitions */
        .metric .value {
            transition: all 0.3s ease;
        }
        
        .value.updating {
            animation: pulse 1s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        /* Toast Notifications */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #1e293b;
            border: 1px solid #334155;
            border-radius: 0.5rem;
            padding: 1rem 1.5rem;
            color: #e2e8f0;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5);
            z-index: 1000;
            transform: translateX(100%);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .toast.show {
            transform: translateX(0);
        }
        
        .toast.success {
            border-left: 4px solid #22c55e;
        }
        
        .toast.error {
            border-left: 4px solid #ef4444;
        }
        
        .toast.warning {
            border-left: 4px solid #f59e0b;
        }
        
        .config-section {
            background: #1e293b;
            border: 1px solid #334155;
            border-radius: 0.5rem;
            padding: 2rem;
            margin-bottom: 2rem;
        }
        
        .form-group {
            margin-bottom: 1.5rem;
        }
        
        label {
            display: block;
            margin-bottom: 0.5rem;
            color: #94a3b8;
        }
        
        input[type="text"],
        input[type="email"],
        input[type="password"],
        input[type="number"] {
            width: 100%;
            padding: 0.5rem;
            background: #0f172a;
            border: 1px solid #334155;
            border-radius: 0.25rem;
            color: #e2e8f0;
        }
        
        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        button {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 0.25rem;
            cursor: pointer;
            font-size: 1rem;
        }
        
        button:hover {
            background: #2563eb;
        }
        
        /* Enhanced Tab styles */
        .tabs {
            display: flex;
            gap: 0.5rem;
            border-bottom: 2px solid #334155;
            margin-bottom: 2rem;
            position: relative;
        }
        
        .tab {
            padding: 1rem 2rem;
            background: none;
            border: none;
            color: #94a3b8;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-size: 1rem;
            font-weight: 500;
            position: relative;
            min-height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .tab:hover:not(.active) {
            color: #e2e8f0;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 0.5rem 0.5rem 0 0;
        }
        
        .tab.active {
            color: #3b82f6;
            border-bottom-color: #3b82f6;
            background: rgba(59, 130, 246, 0.1);
            border-radius: 0.5rem 0.5rem 0 0;
        }
        
        /* Mobile-optimized tabs */
        @media (max-width: 768px) {
            .tabs {
                gap: 0;
                background: #1e293b;
                border-radius: 0.5rem;
                padding: 0.25rem;
                border-bottom: none;
                margin-bottom: 1.5rem;
            }
            
            .tab {
                flex: 1;
                padding: 0.75rem 1rem;
                border-radius: 0.25rem;
                border-bottom: none;
                font-size: 0.875rem;
            }
            
            .tab.active {
                background: #3b82f6;
                color: white;
                border-radius: 0.25rem;
            }
            
            .tab:hover:not(.active) {
                background: rgba(255, 255, 255, 0.1);
                border-radius: 0.25rem;
            }
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* Chart type button styles */
        .chart-type-btn {
            padding: 0.5rem 1rem;
            background: #334155;
            border: 1px solid #475569;
            color: #94a3b8;
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .chart-type-btn:hover {
            background: #475569;
            color: #e2e8f0;
        }
        
        .chart-type-btn.active {
            background: #3b82f6;
            border-color: #3b82f6;
            color: white;
        }
        
        .alert {
            background: #dc2626;
            color: white;
            padding: 1rem;
            border-radius: 0.25rem;
            margin-bottom: 1rem;
            display: none;
        }
        
        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 0.5rem;
        }
        
        .status-indicator.online { background: #22c55e; }
        .status-indicator.offline { background: #dc2626; }
        
        .threshold-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }
        
        /* Modal styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
        }
        
        .modal-content {
            background-color: #1e293b;
            margin: 10% auto;
            padding: 2rem;
            border: 1px solid #334155;
            border-radius: 0.5rem;
            width: 90%;
            max-width: 500px;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }
        
        .close {
            color: #94a3b8;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        
        .close:hover,
        .close:focus {
            color: #f1f5f9;
        }
        
        .link-button {
            background: none;
            border: none;
            color: #3b82f6;
            text-decoration: underline;
            cursor: pointer;
            font-size: inherit;
            padding: 0;
        }
        
        .link-button:hover {
            color: #2563eb;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>EG4-SRP Monitor</h1>
        
        <div id="alert" class="alert"></div>
        
        <!-- Tab Navigation -->
        <div class="tabs">
            <button class="tab active" onclick="switchTab('monitoring')">Monitoring</button>
            <button class="tab" onclick="switchTab('alerts')">Configuration</button>
        </div>
        
        <!-- Monitoring Tab -->
        <div id="monitoring-tab" class="tab-content active">
            <div class="grid">
            <!-- EG4 Status -->
            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                    <div>
                        <h2 style="margin: 0;">EG4 Inverter Status</h2>
                        <div style="color: #64748b; font-size: 0.75rem; margin-top: 0.25rem;">
                            Last updated: <span id="eg4-last-update">--</span>
                        </div>
                    </div>
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                        <label style="display: flex; align-items: center; gap: 0.5rem; margin: 0;">
                            <input type="checkbox" id="auto-refresh" checked style="cursor: pointer;">
                            <span style="font-size: 0.875rem;">Auto-refresh</span>
                        </label>
                        <select id="refresh-interval" style="background: #1e293b; color: #e2e8f0; border: 1px solid #475569; padding: 0.25rem 0.5rem; border-radius: 0.25rem; font-size: 0.875rem;">
                            <option value="30">30s</option>
                            <option value="60" selected>60s</option>
                            <option value="120">2m</option>
                            <option value="300">5m</option>
                        </select>
                        <button onclick="refreshEG4(event)" style="padding: 0.5rem 1rem; font-size: 0.875rem;">Refresh Now</button>
                    </div>
                </div>
                <div class="metric">
                    <span>Battery SOC</span>
                    <span class="value" id="battery-soc">--</span>
                </div>
                <div class="metric">
                    <span>Battery Power</span>
                    <span class="value" id="battery-power">--</span>
                </div>
                <div class="metric">
                    <span>PV Power</span>
                    <span class="value positive" id="pv-power">--</span>
                </div>
                <div class="metric" id="pv-strings" style="display: none; font-size: 0.8rem; color: #94a3b8; border-top: 1px solid #334155; padding-top: 0.5rem; margin-top: 0.5rem;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 0.5rem; text-align: center;">
                        <div id="pv1-details">PV1: <span id="pv1-power">--</span>W<br><span id="pv1-voltage">--</span>V</div>
                        <div id="pv2-details">PV2: <span id="pv2-power">--</span>W<br><span id="pv2-voltage">--</span>V</div>
                        <div id="pv3-details">PV3: <span id="pv3-power">--</span>W<br><span id="pv3-voltage">--</span>V</div>
                    </div>
                </div>
                <div class="metric">
                    <span>Grid Power</span>
                    <span class="value" id="grid-power">--</span>
                </div>
                <div class="metric">
                    <span>Load Power</span>
                    <span class="value" id="load-power">--</span>
                </div>
                <div class="metric">
                    <span>Battery Voltage</span>
                    <span class="value" id="battery-voltage">--</span>
                </div>
                <div class="metric">
                    <span>Grid Voltage</span>
                    <span class="value" id="grid-voltage">--</span>
                </div>
                <div class="metric">
                    <span>Status</span>
                    <span><span class="status-indicator offline" id="eg4-status"></span><span id="eg4-status-text">Offline</span></span>
                </div>
            </div>
            
            <!-- SRP Status -->
            <div class="card">
                <div>
                    <h2 style="margin: 0;">SRP Peak Demand</h2>
                    <div style="color: #64748b; font-size: 0.75rem; margin-top: 0.25rem;">
                        Last updated: <span id="srp-last-update">--</span>
                    </div>
                </div>
                <div class="metric" style="margin-top: 1rem;">
                    <span>Current Peak</span>
                    <span class="value warning" id="peak-demand" style="font-size: 1.5rem;">-- kW</span>
                </div>
                <div class="metric">
                    <span>Next Update</span>
                    <span class="value" id="srp-next-update" style="font-size: 0.875rem;">--</span>
                </div>
                <div class="metric">
                    <span>Status</span>
                    <span><span class="status-indicator offline" id="srp-status"></span><span id="srp-status-text">Offline</span></span>
                </div>
                <div style="margin-top: 0.5rem; padding: 0.5rem; background: #1e293b; border-radius: 0.25rem;">
                    <p style="margin: 0; color: #64748b; font-size: 0.75rem; text-align: center;">
                        Updates daily at <span id="srp-update-time">6:00 AM</span> in your timezone
                    </p>
                </div>
            </div>
        </div>
        
        <!-- SRP Energy Usage Chart -->
        <div class="card" style="margin-top: 1.5rem;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                <div>
                    <h2 style="margin: 0;">SRP Energy Usage</h2>
                    <div style="color: #64748b; font-size: 0.75rem; margin-top: 0.25rem;">
                        Chart data: <span id="chart-last-update">--</span>
                    </div>
                </div>
                <button onclick="loadSRPChart()" style="padding: 0.5rem 1rem; font-size: 0.875rem;">Refresh Chart</button>
            </div>
            <!-- Chart Type Selector -->
            <div style="display: flex; gap: 0.5rem; margin-bottom: 1rem;">
                <button class="chart-type-btn active" data-chart-type="net" onclick="switchChartType('net')">Net energy</button>
                <button class="chart-type-btn" data-chart-type="generation" onclick="switchChartType('generation')">Generation</button>
                <button class="chart-type-btn" data-chart-type="usage" onclick="switchChartType('usage')">Usage</button>
                <button class="chart-type-btn" data-chart-type="demand" onclick="switchChartType('demand')">Demand</button>
            </div>
            <div style="position: relative; height: 400px;">
                <canvas id="srpChart"></canvas>
            </div>
            <div id="chart-info" style="margin-top: 0.5rem; color: #64748b; font-size: 0.75rem;">
                <p style="margin: 0;">• Blue bars: Off-peak usage | Red bars: On-peak usage</p>
                <p style="margin: 0;">• Lines: High/Low temperatures</p>
                <p style="margin: 0;">• Negative values indicate energy export to grid</p>
            </div>
        </div>
        </div>
        
        <!-- Alert Configuration Tab -->
        <div id="alerts-tab" class="tab-content">
            <div class="config-section">
            <h2 style="margin-bottom: 1.5rem;">Configuration</h2>
            
            <!-- Timezone Settings -->
            <div class="form-group" style="background: #334155; padding: 1rem; border-radius: 0.5rem; margin-bottom: 1.5rem;">
                <div style="display: flex; align-items: center; gap: 1rem;">
                    <label style="margin: 0; font-weight: bold; color: #f1f5f9;">Timezone:</label>
                    <select id="timezone-select" style="background: #1e293b; color: #e2e8f0; border: 1px solid #475569; padding: 0.5rem; border-radius: 0.25rem; cursor: pointer;">
                        <option value="UTC">UTC</option>
                        <option value="America/Phoenix" selected>Phoenix (MST)</option>
                        <option value="America/Los_Angeles">Los Angeles (PST/PDT)</option>
                        <option value="America/Denver">Denver (MST/MDT)</option>
                        <option value="America/Chicago">Chicago (CST/CDT)</option>
                        <option value="America/New_York">New York (EST/EDT)</option>
                    </select>
                    <span id="current-time" style="color: #94a3b8; font-size: 0.875rem;"></span>
                </div>
                <p style="margin: 0.5rem 0 0 0; color: #94a3b8; font-size: 0.75rem;">
                    All alert times use the selected timezone. Container will restart when timezone is changed.
                </p>
            </div>
            
            <!-- Credentials Section -->
            <div class="form-group" style="background: #334155; padding: 1.5rem; border-radius: 0.5rem; margin-bottom: 1.5rem;">
                <h3 style="margin: 0 0 1rem 0; color: #f1f5f9;">System Credentials</h3>
                <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 1.5rem;">
                    <div>
                        <h4 style="margin: 0 0 0.5rem 0; color: #3b82f6;">EG4 Cloud Account</h4>
                        <div class="form-group">
                            <label>Username</label>
                            <input type="text" id="eg4-username" placeholder="Your EG4 username">
                        </div>
                        <div class="form-group">
                            <label>Password</label>
                            <input type="password" id="eg4-password" placeholder="Your EG4 password">
                        </div>
                    </div>
                    <div>
                        <h4 style="margin: 0 0 0.5rem 0; color: #3b82f6;">SRP Account</h4>
                        <div class="form-group">
                            <label>Username</label>
                            <input type="text" id="srp-username" placeholder="Your SRP username">
                        </div>
                        <div class="form-group">
                            <label>Password</label>
                            <input type="password" id="srp-password" placeholder="Your SRP password">
                        </div>
                    </div>
                </div>
                <p style="margin: 1rem 0 0 0; color: #94a3b8; font-size: 0.75rem;">
                    <strong>Note:</strong> Credentials are securely stored and used only for data collection. 
                    EG4 credentials access your inverter cloud data, SRP credentials access your utility usage data.
                </p>
            </div>
            
            <div class="form-group">
                <div class="checkbox-group">
                    <input type="checkbox" id="email-enabled">
                    <label for="email-enabled" style="margin: 0;">Enable Email Alerts</label>
                </div>
            </div>
            
            <div class="grid">
                <div>
                    <h3 style="margin-bottom: 1rem; color: #f1f5f9;">Email Settings</h3>
                    <div class="form-group">
                        <label>Email Recipients (comma-separated)</label>
                        <input type="text" id="email-to" placeholder="user1@example.com, user2@example.com">
                    </div>
                    <div class="form-group" style="background: #334155; padding: 1rem; border-radius: 0.25rem;">
                        <p style="margin: 0; color: #94a3b8; font-size: 0.875rem;">
                            <strong>Gmail Status:</strong> <span id="gmail-status" style="color: #f59e0b;">Checking...</span>
                            <button id="configure-gmail-btn" class="link-button" style="margin-left: 1rem; display: none;" onclick="showGmailConfig()">Configure</button>
                        </p>
                        <p style="margin: 0.5rem 0 0 0; color: #94a3b8; font-size: 0.875rem;">
                            <strong>Note:</strong> Email alerts are sent via Gmail. Multiple recipients can be separated by commas.
                        </p>
                    </div>
                </div>
                
                <div>
                    <h3 style="margin-bottom: 1rem; color: #f1f5f9;">Alert Thresholds</h3>
                    
                    <!-- Battery Alerts -->
                    <div style="background: #0f172a; padding: 1rem; border-radius: 0.5rem; margin-bottom: 1rem;">
                        <h4 style="margin: 0 0 0.75rem 0; color: #94a3b8; font-size: 1rem;">Battery Alerts</h4>
                        <div class="threshold-grid">
                            <div class="form-group">
                                <label>Low Battery Threshold (%)</label>
                                <input type="number" id="battery-low" min="0" max="100" value="20">
                            </div>
                            <div class="form-group">
                                <label>Check Time (24h)</label>
                                <div style="display: flex; gap: 0.5rem;">
                                    <input type="number" id="battery-check-hour" min="0" max="23" value="6" style="width: 60px;" title="Hour">
                                    <span style="line-height: 2rem;">:</span>
                                    <input type="number" id="battery-check-minute" min="0" max="59" value="0" style="width: 60px;" title="Minute">
                                </div>
                            </div>
                        </div>
                        <p style="margin: 0.5rem 0 0 0; color: #64748b; font-size: 0.75rem;">
                            SOC is checked once daily at the specified time in your selected timezone. Alert sent if below threshold.
                        </p>
                    </div>
                    
                    <!-- Peak Demand Alerts -->
                    <div style="background: #0f172a; padding: 1rem; border-radius: 0.5rem; margin-bottom: 1rem;">
                        <h4 style="margin: 0 0 0.75rem 0; color: #94a3b8; font-size: 1rem;">Peak Demand Alerts</h4>
                        <div class="threshold-grid">
                            <div class="form-group">
                                <label>Peak Demand Threshold (kW)</label>
                                <input type="number" id="peak-demand-threshold" min="0" step="0.1" value="5.0">
                            </div>
                            <div class="form-group">
                                <label>Check Time (24h)</label>
                                <div style="display: flex; gap: 0.5rem;">
                                    <input type="number" id="peak-demand-check-hour" min="0" max="23" value="6" style="width: 60px;" title="Hour">
                                    <span style="line-height: 2rem;">:</span>
                                    <input type="number" id="peak-demand-check-minute" min="0" max="59" value="0" style="width: 60px;" title="Minute">
                                </div>
                            </div>
                        </div>
                        <p style="margin: 0.5rem 0 0 0; color: #64748b; font-size: 0.75rem;">
                            Peak demand is checked once daily at the specified time in your selected timezone. Alert sent if exceeds threshold.
                        </p>
                    </div>
                    
                    <!-- Grid Import Alerts -->
                    <div style="background: #0f172a; padding: 1rem; border-radius: 0.5rem; margin-bottom: 1rem;">
                        <h4 style="margin: 0 0 0.75rem 0; color: #94a3b8; font-size: 1rem;">Grid Import Alerts</h4>
                        <div class="threshold-grid">
                            <div class="form-group">
                                <label>Import Threshold (W)</label>
                                <input type="number" id="grid-import" min="0" value="10000">
                            </div>
                            <div class="form-group">
                                <label>Start Hour (24h)</label>
                                <input type="number" id="grid-import-start-hour" min="0" max="23" value="14" title="14 = 2:00 PM">
                            </div>
                            <div class="form-group">
                                <label>End Hour (24h)</label>
                                <input type="number" id="grid-import-end-hour" min="0" max="23" value="20" title="20 = 8:00 PM">
                            </div>
                        </div>
                        <p style="margin: 0.5rem 0 0 0; color: #64748b; font-size: 0.75rem;">
                            Only triggers during the specified hours when import exceeds threshold. Times in your selected timezone.
                        </p>
                    </div>
                </div>
            </div>
            
            <div style="display: flex; gap: 1rem; margin-top: 1.5rem;">
                <button onclick="saveConfig()">Save Configuration</button>
                <button onclick="testEmail()" style="background: #475569;">Test Email</button>
            </div>
            <div id="save-feedback" style="margin-top: 0.5rem; padding: 0.5rem 1rem; border-radius: 0.375rem; display: none;"></div>
            
            <!-- System Logs Section -->
            <div style="margin-top: 2rem; border-top: 1px solid #334155; padding-top: 2rem;">
                <h3 style="margin-bottom: 1rem; color: #f1f5f9;">System Logs</h3>
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                    <div style="display: flex; gap: 1rem; align-items: center;">
                        <select id="log-level" onchange="loadLogs()" style="background: #1e293b; color: #e2e8f0; border: 1px solid #475569; padding: 0.5rem; border-radius: 0.25rem;">
                            <option value="ALL">All Levels</option>
                            <option value="ERROR">Errors Only</option>
                            <option value="WARNING">Warnings & Errors</option>
                            <option value="INFO">Info & Above</option>
                        </select>
                        <button onclick="loadLogs()" style="background: #475569; padding: 0.5rem 1rem;">Refresh</button>
                    </div>
                    <div style="display: flex; gap: 0.5rem;">
                        <button onclick="clearLogs()" style="background: #dc2626; padding: 0.5rem 1rem;">Clear Buffer</button>
                        <button onclick="downloadLogs()" style="background: #059669; padding: 0.5rem 1rem;">Download Full Log</button>
                    </div>
                </div>
                <div id="log-info" style="margin-bottom: 0.5rem; color: #64748b; font-size: 0.875rem;"></div>
                <div id="log-container" style="background: #0f172a; border: 1px solid #334155; border-radius: 0.5rem; padding: 1rem; height: 400px; overflow-y: auto; font-family: monospace; font-size: 0.875rem; white-space: pre-wrap; word-wrap: break-word;">
                    <div style="color: #64748b; text-align: center; padding: 2rem;">Loading logs...</div>
                </div>
                <div style="margin-top: 0.5rem; color: #64748b; font-size: 0.75rem;">
                    <p>• Logs are rotated at 10MB with 3 backup files</p>
                    <p>• In-memory buffer holds last 1000 log entries</p>
                    <p>• Application logs: <code style="background: #334155; padding: 0.2rem 0.4rem; border-radius: 0.25rem;">tail -f logs/eg4_srp_monitor.log</code></p>
                </div>
            </div>
        </div>
    </div>
        </div>
    
    <!-- Gmail Configuration Modal -->
    <div id="gmail-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 style="margin: 0; color: #f1f5f9;">Configure Gmail</h2>
                <span class="close" onclick="closeGmailConfig()">&times;</span>
            </div>
            
            <div class="form-group">
                <label>Email Address</label>
                <input type="email" id="gmail-address" placeholder="your-email@domain.com">
                <p style="margin: 0.5rem 0 0 0; color: #94a3b8; font-size: 0.875rem;">
                    Works with Gmail and Google Workspace custom domains
                </p>
            </div>
            
            <div class="form-group">
                <label>Google App Password</label>
                <input type="password" id="gmail-app-password" placeholder="16-character app password">
                <p style="margin: 0.5rem 0 0 0; color: #94a3b8; font-size: 0.875rem;">
                    <a href="https://myaccount.google.com/apppasswords" target="_blank" style="color: #3b82f6;">
                        Create an App Password
                    </a> (not your regular password)
                </p>
            </div>
            
            <div id="gmail-config-error" style="display: none; background: #dc2626; color: white; padding: 0.5rem; border-radius: 0.25rem; margin-bottom: 1rem;"></div>
            
            <div style="background: #334155; padding: 1rem; border-radius: 0.25rem; margin-bottom: 1rem;">
                <p style="margin: 0 0 0.5rem 0; color: #f1f5f9; font-weight: bold;">Instructions:</p>
                <ol style="margin: 0; padding-left: 1.5rem; color: #94a3b8; font-size: 0.875rem;">
                    <li>Go to Google Account settings</li>
                    <li>Enable 2-Step Verification if not already enabled</li>
                    <li>Generate an App Password for "Mail"</li>
                    <li>Copy the 16-character password (without spaces)</li>
                    <li>Enter it above along with your email address</li>
                </ol>
            </div>
            
            <button onclick="configureGmail()" style="width: 100%;">Configure Gmail</button>
        </div>
    </div>
    
    <script>
        const socket = io();
        
        // Tab switching functionality
        function switchTab(tabName) {
            // Update active tab button
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Update active tab content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(tabName + '-tab').classList.add('active');
            
            // Load logs when switching to configuration/alerts tab
            if (tabName === 'alerts') {
                loadLogs();
            }
        }
        
        // Update EG4 data
        socket.on('eg4_update', (data) => {
            document.getElementById('battery-soc').textContent = data.battery.soc + '%';
            document.getElementById('battery-soc').className = 'value ' + 
                (data.battery.soc < 20 ? 'negative' : data.battery.soc > 95 ? 'warning' : '');
            
            document.getElementById('battery-power').textContent = data.battery.power + 'W';
            document.getElementById('battery-power').className = 'value ' + 
                (data.battery.power < 0 ? 'negative' : 'positive');
            
            // Update total PV power
            document.getElementById('pv-power').textContent = data.pv.power + 'W';
            
            // Update individual PV string details if available
            if (data.pv.strings) {
                const strings = data.pv.strings;
                
                // Update PV1
                if (strings.pv1 && strings.pv1.power > 0) {
                    document.getElementById('pv1-power').textContent = strings.pv1.power;
                    document.getElementById('pv1-voltage').textContent = strings.pv1.voltage.toFixed(1);
                    document.getElementById('pv1-details').style.display = 'block';
                } else {
                    document.getElementById('pv1-details').style.display = 'none';
                }
                
                // Update PV2
                if (strings.pv2 && strings.pv2.power > 0) {
                    document.getElementById('pv2-power').textContent = strings.pv2.power;
                    document.getElementById('pv2-voltage').textContent = strings.pv2.voltage.toFixed(1);
                    document.getElementById('pv2-details').style.display = 'block';
                } else {
                    document.getElementById('pv2-details').style.display = 'none';
                }
                
                // Update PV3
                if (strings.pv3 && strings.pv3.power > 0) {
                    document.getElementById('pv3-power').textContent = strings.pv3.power;
                    document.getElementById('pv3-voltage').textContent = strings.pv3.voltage.toFixed(1);
                    document.getElementById('pv3-details').style.display = 'block';
                } else {
                    document.getElementById('pv3-details').style.display = 'none';
                }
                
                // Show the strings section if any string has power
                const anyStringActive = (strings.pv1?.power > 0) || (strings.pv2?.power > 0) || (strings.pv3?.power > 0);
                document.getElementById('pv-strings').style.display = anyStringActive ? 'block' : 'none';
            }
            document.getElementById('grid-power').textContent = data.grid.power + 'W';
            document.getElementById('grid-power').className = 'value ' + 
                (data.grid.power > 0 ? 'negative' : 'positive');
            
            document.getElementById('load-power').textContent = data.load.power + 'W';
            
            document.getElementById('battery-voltage').textContent = data.battery.voltage + 'V';
            document.getElementById('grid-voltage').textContent = data.grid.voltage + 'V';
            
            document.getElementById('eg4-status').className = 'status-indicator online';
            document.getElementById('eg4-status-text').textContent = 'Online';
            
            // Update last update time from data if available
            if (data.last_update) {
                const updateTime = new Date(data.last_update);
                document.getElementById('eg4-last-update').textContent = updateTime.toLocaleString();
            } else {
                const now = new Date();
                document.getElementById('eg4-last-update').textContent = now.toLocaleString();
            }
        });
        
        // Update SRP data
        socket.on('srp_update', (data) => {
            document.getElementById('peak-demand').textContent = data.demand.toFixed(1) + ' kW';
            
            // Use last_daily_update if available, otherwise use timestamp
            const timeField = data.last_daily_update || data.timestamp;
            if (timeField) {
                const updateTime = new Date(timeField);
                document.getElementById('srp-last-update').textContent = updateTime.toLocaleString();
            }
            
            // Update CSV data timestamp if available
            if (data.csv_last_update) {
                const csvTime = new Date(data.csv_last_update);
                document.getElementById('chart-last-update').textContent = csvTime.toLocaleString();
            }
            
            document.getElementById('srp-status').className = 'status-indicator online';
            document.getElementById('srp-status-text').textContent = 'Online';
            
            // Log debug info if available
            if (data.debug) {
                console.log('SRP debug info:', data.debug);
            }
        });
        
        // Handle alerts
        socket.on('alert', (data) => {
            const alertDiv = document.getElementById('alert');
            alertDiv.style.display = 'block';
            alertDiv.innerHTML = `<strong>${data.subject}:</strong> ${data.message}`;
            
            setTimeout(() => {
                alertDiv.style.display = 'none';
            }, 10000);
        });
        
        // Load configuration
        async function loadConfig() {
            const response = await fetch('/api/config');
            const config = await response.json();
            
            document.getElementById('email-enabled').checked = config.email_enabled;
            document.getElementById('email-to').value = config.email_to || '';
            
            document.getElementById('battery-low').value = config.thresholds.battery_low;
            document.getElementById('battery-check-hour').value = config.thresholds.battery_check_hour || 6;
            document.getElementById('battery-check-minute').value = config.thresholds.battery_check_minute || 0;
            document.getElementById('peak-demand-threshold').value = config.thresholds.peak_demand;
            document.getElementById('peak-demand-check-hour').value = config.thresholds.peak_demand_check_hour || 6;
            document.getElementById('peak-demand-check-minute').value = config.thresholds.peak_demand_check_minute || 0;
            document.getElementById('grid-import').value = config.thresholds.grid_import;
            document.getElementById('grid-import-start-hour').value = config.thresholds.grid_import_start_hour || 14;
            document.getElementById('grid-import-end-hour').value = config.thresholds.grid_import_end_hour || 20;
            
            // Set timezone
            if (config.timezone) {
                document.getElementById('timezone-select').value = config.timezone;
            }
            
            // Load credentials
            if (config.credentials) {
                document.getElementById('eg4-username').value = config.credentials.eg4_username || '';
                document.getElementById('eg4-password').value = config.credentials.eg4_password || '';
                document.getElementById('srp-username').value = config.credentials.srp_username || '';
                document.getElementById('srp-password').value = config.credentials.srp_password || '';
            }
            
            // Update SRP next update display
            updateSRPNextUpdate();
        }
        
        // Save configuration
        async function saveConfig() {
            const feedbackEl = document.getElementById('save-feedback');
            
            // Show saving message
            feedbackEl.style.display = 'block';
            feedbackEl.style.background = '#3b82f6';
            feedbackEl.style.color = '#ffffff';
            feedbackEl.textContent = 'Saving configuration...';
            
            const config = {
                email_enabled: document.getElementById('email-enabled').checked,
                email_to: document.getElementById('email-to').value,
                timezone: document.getElementById('timezone-select').value,
                credentials: {
                    eg4_username: document.getElementById('eg4-username').value,
                    eg4_password: document.getElementById('eg4-password').value,
                    srp_username: document.getElementById('srp-username').value,
                    srp_password: document.getElementById('srp-password').value
                },
                thresholds: {
                    battery_low: parseInt(document.getElementById('battery-low').value),
                    battery_check_hour: parseInt(document.getElementById('battery-check-hour').value),
                    battery_check_minute: parseInt(document.getElementById('battery-check-minute').value),
                    peak_demand: parseFloat(document.getElementById('peak-demand-threshold').value),
                    peak_demand_check_hour: parseInt(document.getElementById('peak-demand-check-hour').value),
                    peak_demand_check_minute: parseInt(document.getElementById('peak-demand-check-minute').value),
                    grid_import: parseInt(document.getElementById('grid-import').value),
                    grid_import_start_hour: parseInt(document.getElementById('grid-import-start-hour').value),
                    grid_import_end_hour: parseInt(document.getElementById('grid-import-end-hour').value)
                }
            };
            
            try {
                const response = await fetch('/api/config', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(config)
                });
                
                if (response.ok) {
                    // Show success feedback
                    feedbackEl.style.display = 'none';
                    showToast('Configuration saved successfully!', 'success');
                    
                    // If credentials were updated, restart monitoring
                    if (config.credentials.eg4_username || config.credentials.eg4_password || 
                        config.credentials.srp_username || config.credentials.srp_password) {
                        // Trigger a manual refresh to use new credentials
                        setTimeout(() => {
                            fetch('/api/refresh', { method: 'POST' })
                                .then(() => console.log('Triggered manual refresh with new credentials'));
                        }, 1000);
                    }
                } else {
                    // Show error feedback
                    const error = await response.json();
                    feedbackEl.style.display = 'none';
                    showToast('Failed to save: ' + (error.message || 'Unknown error'), 'error');
                }
            } catch (error) {
                // Show error feedback
                feedbackEl.style.display = 'none';
                showToast('Failed to save: ' + error.message, 'error');
            }
        }
        
        // Test email
        async function testEmail() {
            const button = event.target;
            const originalText = button.textContent;
            button.disabled = true;
            button.textContent = 'Sending...';
            
            try {
                const response = await fetch('/api/test-email');
                const result = await response.json();
                
                if (response.ok) {
                    showToast('Test email sent! Check your inbox.', 'success');
                } else {
                    // Show detailed error message
                    let errorMsg = result.message || 'Failed to send test email';
                    
                    // If gmail is not configured, offer to configure it
                    if (result.gmail_configured === false) {
                        showToast(errorMsg, 'error', 5000);
                        setTimeout(() => {
                            if (confirm('Gmail is not configured.\n\nWould you like to configure Gmail now?')) {
                                showGmailConfig();
                            }
                        }, 1000);
                    } else {
                        showToast(errorMsg, 'error');
                    }
                }
            } catch (error) {
                showToast('Error sending test email: ' + error.message, 'error');
            } finally {
                button.disabled = false;
                button.textContent = originalText;
            }
        }
        
        // Show Gmail configuration modal
        function showGmailConfig() {
            document.getElementById('gmail-modal').style.display = 'block';
            document.getElementById('gmail-config-error').style.display = 'none';
        }
        
        // Close Gmail configuration modal
        function closeGmailConfig() {
            document.getElementById('gmail-modal').style.display = 'none';
            document.getElementById('gmail-address').value = '';
            document.getElementById('gmail-app-password').value = '';
            document.getElementById('gmail-config-error').style.display = 'none';
        }
        
        // Configure Gmail
        async function configureGmail() {
            const email = document.getElementById('gmail-address').value.trim();
            const password = document.getElementById('gmail-app-password').value.trim();
            const errorDiv = document.getElementById('gmail-config-error');
            
            if (!email) {
                errorDiv.textContent = 'Please enter your Gmail address';
                errorDiv.style.display = 'block';
                return;
            }
            
            if (!password) {
                errorDiv.textContent = 'Please enter your Gmail app password';
                errorDiv.style.display = 'block';
                return;
            }
            
            // Disable button while configuring
            const button = event.target;
            button.disabled = true;
            button.textContent = 'Configuring...';
            
            try {
                const response = await fetch('/api/configure-gmail', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        email_address: email,
                        app_password: password
                    })
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    alert(result.message);
                    closeGmailConfig();
                    checkGmailStatus();
                } else {
                    errorDiv.textContent = result.message;
                    errorDiv.style.display = 'block';
                }
            } catch (error) {
                errorDiv.textContent = 'Error configuring Gmail: ' + error.message;
                errorDiv.style.display = 'block';
            } finally {
                button.disabled = false;
                button.textContent = 'Configure Gmail';
            }
        }
        
        // Check Gmail status
        async function checkGmailStatus() {
            try {
                const response = await fetch('/api/gmail-status');
                const data = await response.json();
                const statusEl = document.getElementById('gmail-status');
                
                if (data.configured) {
                    statusEl.textContent = 'Configured ✓';
                    statusEl.style.color = '#22c55e';
                    document.getElementById('configure-gmail-btn').style.display = 'none';
                } else {
                    statusEl.textContent = 'Not configured ✗';
                    statusEl.style.color = '#ef4444';
                    statusEl.title = data.message;
                    document.getElementById('configure-gmail-btn').style.display = 'inline';
                }
            } catch (error) {
                const statusEl = document.getElementById('gmail-status');
                statusEl.textContent = 'Error checking status';
                statusEl.style.color = '#ef4444';
            }
        }
        
        // Refresh EG4 data manually
        async function refreshEG4(event = null) {
            let button = null;
            if (event && event.target) {
                button = event.target;
                button.disabled = true;
                button.textContent = 'Refreshing...';
            }
            
            try {
                const response = await fetch('/api/refresh-eg4', { method: 'POST' });
                const result = await response.json();
                
                if (response.ok) {
                    showToast('Data refreshed successfully', 'success');
                } else {
                    showToast('Failed to refresh: ' + (result.message || 'Unknown error'), 'error');
                }
            } catch (error) {
                showToast('Error refreshing data: ' + error.message, 'error');
            } finally {
                if (button) {
                    button.disabled = false;
                    button.textContent = 'Refresh Now';
                }
            }
        }
        
        // Update current time display
        function updateCurrentTime() {
            const now = new Date();
            const timeStr = now.toLocaleTimeString('en-US', {
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                hour12: false
            });
            const dateStr = now.toLocaleDateString('en-US', {
                weekday: 'short',
                month: 'short',
                day: 'numeric'
            });
            document.getElementById('current-time').textContent = `Current time: ${dateStr} ${timeStr}`;
        }
        
        // Handle timezone change
        async function handleTimezoneChange() {
            const timezone = document.getElementById('timezone-select').value;
            
            // Save configuration first
            await saveConfig();
            
            // Show notification about container restart
            if (confirm('Changing timezone requires a container restart. The application will be unavailable for about 30 seconds. Continue?')) {
                // Update timezone on server
                const response = await fetch('/api/timezone', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ timezone })
                });
                
                if (response.ok) {
                    alert('Timezone updated. The container is restarting...');
                    // Reload page after delay
                    setTimeout(() => {
                        window.location.reload();
                    }, 5000);
                } else {
                    alert('Failed to update timezone');
                    // Reload config to restore previous value
                    loadConfig();
                }
            } else {
                // Restore previous value
                loadConfig();
            }
        }
        
        // Set up timezone change handler
        document.getElementById('timezone-select').addEventListener('change', handleTimezoneChange);
        
        // Update time every second
        setInterval(updateCurrentTime, 1000);
        updateCurrentTime();
        
        // Log functions
        async function loadLogs() {
            const levelElement = document.getElementById('log-level');
            if (!levelElement) return; // Exit if element doesn't exist
            
            const level = levelElement.value;
            const lines = 100; // Default to 100 lines
            
            try {
                const response = await fetch(`/api/logs?level=${level}&lines=${lines}`);
                const data = await response.json();
                
                // Update log info
                document.getElementById('log-info').innerHTML = 
                    `Showing ${data.logs.length} of ${data.total_buffered} buffered entries | ` +
                    `Log file: ${data.log_file} (Max: ${data.max_size_mb}MB, Rotations: ${data.rotation_count})`;
                
                // Display logs
                const container = document.getElementById('log-container');
                if (data.logs.length === 0) {
                    container.innerHTML = '<div style="color: #64748b; text-align: center; padding: 2rem;">No logs matching criteria</div>';
                } else {
                    container.innerHTML = data.logs.map(log => {
                        const levelColor = {
                            'ERROR': '#ef4444',
                            'WARNING': '#f59e0b',
                            'INFO': '#3b82f6',
                            'DEBUG': '#8b5cf6'
                        }[log.level] || '#94a3b8';
                        
                        // Format timestamp
                        const date = new Date(log.timestamp * 1000);
                        const timeStr = date.toLocaleString();
                        
                        return `<div style="margin-bottom: 0.5rem;"><span style="color: ${levelColor};">${log.message}</span></div>`;
                    }).join('');
                    
                    // Scroll to bottom
                    container.scrollTop = container.scrollHeight;
                }
            } catch (error) {
                console.error('Failed to load logs:', error);
                document.getElementById('log-container').innerHTML = 
                    '<div style="color: #ef4444; text-align: center; padding: 2rem;">Failed to load logs</div>';
            }
        }
        
        async function clearLogs() {
            if (!confirm('Clear the in-memory log buffer? This will not affect the log file.')) {
                return;
            }
            
            try {
                const response = await fetch('/api/logs/clear', { method: 'POST' });
                if (response.ok) {
                    loadLogs();
                } else {
                    alert('Failed to clear logs');
                }
            } catch (error) {
                console.error('Failed to clear logs:', error);
                alert('Failed to clear logs');
            }
        }
        
        async function downloadLogs() {
            try {
                const response = await fetch('/api/logs/download');
                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = response.headers.get('content-disposition').split('filename=')[1];
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                } else {
                    alert('Failed to download logs');
                }
            } catch (error) {
                console.error('Failed to download logs:', error);
                alert('Failed to download logs');
            }
        }
        
        // Load initial data
        loadConfig();
        checkGmailStatus();
        
        // Auto-refresh logs every 5 seconds when on configuration tab
        let logRefreshInterval = null;
        function startLogRefresh() {
            // Load logs immediately if on configuration tab
            if (document.getElementById('alerts-tab').classList.contains('active')) {
                loadLogs();
            }
            
            if (logRefreshInterval) clearInterval(logRefreshInterval);
            logRefreshInterval = setInterval(() => {
                if (document.getElementById('alerts-tab').classList.contains('active')) {
                    loadLogs();
                }
            }, 5000);
        }
        startLogRefresh();
        
        // Auto-refresh functionality
        let autoRefreshInterval = null;
        
        function setupAutoRefresh() {
            const isEnabled = document.getElementById('auto-refresh').checked;
            const interval = parseInt(document.getElementById('refresh-interval').value) * 1000;
            
            // Clear existing interval
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
                autoRefreshInterval = null;
            }
            
            // Set up new interval if enabled
            if (isEnabled) {
                autoRefreshInterval = setInterval(() => {
                    refreshEG4(null); // Pass null for auto-refresh (no button to disable)
                }, interval);
            }
        }
        
        // Update SRP next update time
        function updateSRPNextUpdate() {
            const hour = parseInt(document.getElementById('peak-demand-check-hour').value) || 6;
            const minute = parseInt(document.getElementById('peak-demand-check-minute').value) || 0;
            
            // Update display time
            const timeStr = `${hour.toString().padStart(2, '0')}:${minute.toString().padStart(2, '0')}`;
            document.getElementById('srp-update-time').textContent = `${timeStr}`;
            
            // Calculate next update
            const now = new Date();
            const nextUpdate = new Date();
            nextUpdate.setHours(hour, minute, 0, 0);
            
            // If time has passed today, set for tomorrow
            if (nextUpdate <= now) {
                nextUpdate.setDate(nextUpdate.getDate() + 1);
            }
            
            // Format next update time
            const options = { 
                weekday: 'short', 
                month: 'short', 
                day: 'numeric', 
                hour: '2-digit', 
                minute: '2-digit' 
            };
            document.getElementById('srp-next-update').textContent = nextUpdate.toLocaleString(undefined, options);
        }
        
        // Set up auto-refresh handlers
        document.getElementById('auto-refresh').addEventListener('change', setupAutoRefresh);
        document.getElementById('refresh-interval').addEventListener('change', setupAutoRefresh);
        
        // Update SRP time when config changes
        document.getElementById('peak-demand-check-hour').addEventListener('change', updateSRPNextUpdate);
        document.getElementById('peak-demand-check-minute').addEventListener('change', updateSRPNextUpdate);
        
        // Initialize auto-refresh
        setupAutoRefresh();
        updateSRPNextUpdate();
        
        // SRP Chart functionality
        let srpChart = null;
        let currentChartType = 'net';
        
        function switchChartType(chartType) {
            // Update active button
            document.querySelectorAll('.chart-type-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`[data-chart-type="${chartType}"]`).classList.add('active');
            
            // Update current chart type and reload
            currentChartType = chartType;
            
            // Update chart info text
            const chartInfo = document.getElementById('chart-info');
            switch(chartType) {
                case 'net':
                    chartInfo.innerHTML = `
                        <p style="margin: 0;">• Blue bars: Off-peak usage | Red bars: On-peak usage</p>
                        <p style="margin: 0;">• Lines: High/Low temperatures</p>
                        <p style="margin: 0;">• Negative values indicate energy export to grid</p>
                    `;
                    break;
                case 'generation':
                    chartInfo.innerHTML = `
                        <p style="margin: 0;">• Green bars: Solar generation</p>
                        <p style="margin: 0;">• Red bars: Energy consumption</p>
                        <p style="margin: 0;">• Compare your solar production to usage</p>
                    `;
                    break;
                case 'usage':
                    chartInfo.innerHTML = `
                        <p style="margin: 0;">• Blue bars: Off-peak usage | Red bars: On-peak usage</p>
                        <p style="margin: 0;">• Shows total energy consumption from grid</p>
                        <p style="margin: 0;">• Positive values only (no export shown)</p>
                    `;
                    break;
                case 'demand':
                    chartInfo.innerHTML = `
                        <p style="margin: 0;">• Orange bars: Peak demand in kW</p>
                        <p style="margin: 0;">• Shows highest power draw for each day</p>
                        <p style="margin: 0;">• Important for demand-based billing plans</p>
                    `;
                    break;
            }
            
            loadSRPChart();
        }
        
        async function loadSRPChart() {
            try {
                const response = await fetch(`/api/srp-chart-data?type=${currentChartType}`);
                if (!response.ok) {
                    throw new Error('Failed to load chart data');
                }
                
                const data = await response.json();
                
                // Create chart configuration based on chart type
                let datasets = [];
                let chartTitle = '';
                let yAxisTitle = 'Energy (kWh)';
                let stackedY = false;
                
                if (data.chartType === 'net' || data.chartType === 'usage') {
                    // Net energy and Usage charts
                    chartTitle = data.chartType === 'net' ? 'Net Energy' : 'Energy Usage';
                    stackedY = true;
                    datasets = [
                        {
                            label: 'Off-Peak kWh',
                            data: data.offPeak,
                            backgroundColor: 'rgba(59, 130, 246, 0.8)', // Blue
                            borderColor: 'rgba(59, 130, 246, 1)',
                            borderWidth: 1,
                            order: 2
                        },
                        {
                            label: 'On-Peak kWh',
                            data: data.onPeak,
                            backgroundColor: 'rgba(239, 68, 68, 0.8)', // Red
                            borderColor: 'rgba(239, 68, 68, 1)',
                            borderWidth: 1,
                            order: 2
                        }
                    ];
                    
                    // Add temperature lines if available
                    if (data.highTemp && data.highTemp.length > 0) {
                        datasets.push(
                            {
                                label: 'High Temp (°F)',
                                data: data.highTemp,
                                type: 'line',
                                borderColor: 'rgba(251, 191, 36, 0.8)', // Amber
                                backgroundColor: 'transparent',
                                borderWidth: 2,
                                pointRadius: 3,
                                yAxisID: 'y1',
                                order: 1
                            },
                            {
                                label: 'Low Temp (°F)',
                                data: data.lowTemp,
                                type: 'line',
                                borderColor: 'rgba(147, 197, 253, 0.8)', // Light blue
                                backgroundColor: 'transparent',
                                borderWidth: 2,
                                pointRadius: 3,
                                yAxisID: 'y1',
                                order: 1
                            }
                        );
                    }
                } else if (data.chartType === 'generation') {
                    // Generation chart
                    chartTitle = 'Solar Generation vs Consumption';
                    datasets = [
                        {
                            label: 'Solar Generation (kWh)',
                            data: data.generation,
                            backgroundColor: 'rgba(34, 197, 94, 0.8)', // Green
                            borderColor: 'rgba(34, 197, 94, 1)',
                            borderWidth: 1
                        },
                        {
                            label: 'Consumption (kWh)',
                            data: data.consumption,
                            backgroundColor: 'rgba(239, 68, 68, 0.8)', // Red
                            borderColor: 'rgba(239, 68, 68, 1)',
                            borderWidth: 1
                        }
                    ];
                } else if (data.chartType === 'demand') {
                    // Demand chart
                    chartTitle = 'Peak Demand';
                    yAxisTitle = 'Demand (kW)';
                    datasets = [
                        {
                            label: 'Peak Demand (kW)',
                            data: data.demand,
                            backgroundColor: 'rgba(251, 146, 60, 0.8)', // Orange
                            borderColor: 'rgba(251, 146, 60, 1)',
                            borderWidth: 1
                        }
                    ];
                }
                
                const config = {
                    type: 'bar',
                    data: {
                        labels: data.labels,
                        datasets: datasets
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: {
                            mode: 'index',
                            intersect: false
                        },
                        plugins: {
                            title: {
                                display: true,
                                text: chartTitle,
                                color: '#e2e8f0',
                                font: {
                                    size: 16
                                }
                            },
                            legend: {
                                labels: {
                                    color: '#e2e8f0'
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        let label = context.dataset.label || '';
                                        if (label) {
                                            label += ': ';
                                        }
                                        if (context.parsed.y !== null) {
                                            if (label.includes('Temp')) {
                                                label += context.parsed.y + '°F';
                                            } else {
                                                label += context.parsed.y + ' kWh';
                                            }
                                        }
                                        return label;
                                    }
                                }
                            }
                        },
                        scales: {
                            x: {
                                stacked: stackedY,
                                grid: {
                                    color: 'rgba(51, 65, 85, 0.5)'
                                },
                                ticks: {
                                    color: '#94a3b8'
                                }
                            },
                            y: {
                                stacked: stackedY,
                                position: 'left',
                                title: {
                                    display: true,
                                    text: yAxisTitle,
                                    color: '#e2e8f0'
                                },
                                grid: {
                                    color: 'rgba(51, 65, 85, 0.5)'
                                },
                                ticks: {
                                    color: '#94a3b8'
                                }
                            }
                        }
                    }
                };
                
                // Only add temperature Y-axis if we have temperature data
                if ((data.chartType === 'net' || data.chartType === 'usage') && data.highTemp && data.highTemp.length > 0) {
                    config.options.scales.y1 = {
                        position: 'right',
                        title: {
                            display: true,
                            text: 'Temperature (°F)',
                            color: '#e2e8f0'
                        },
                        grid: {
                            drawOnChartArea: false
                        },
                        ticks: {
                            color: '#94a3b8'
                        }
                    };
                }
                
                // Destroy existing chart if it exists
                if (srpChart) {
                    srpChart.destroy();
                }
                
                // Create new chart
                const ctx = document.getElementById('srpChart').getContext('2d');
                srpChart = new Chart(ctx, config);
                
                // Don't update timestamp here - let it come from the server
                
            } catch (error) {
                console.error('Failed to load SRP chart:', error);
                // Show error message in chart area
                const canvas = document.getElementById('srpChart');
                const ctx = canvas.getContext('2d');
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.fillStyle = '#94a3b8';
                ctx.font = '16px sans-serif';
                ctx.textAlign = 'center';
                
                // Check if this is a 404 with needsDownload flag
                if (error.message.includes('Failed to load chart data')) {
                    ctx.fillText(`No ${currentChartType} data available. Data will be downloaded at next scheduled update.`, canvas.width / 2, canvas.height / 2 - 10);
                    ctx.fillText(`You can also download manually using the button above.`, canvas.width / 2, canvas.height / 2 + 10);
                    
                    // Add download button functionality if needed
                    const refreshBtn = document.querySelector('button[onclick="loadSRPChart()"]');
                    if (refreshBtn && !refreshBtn.hasAttribute('data-download-enabled')) {
                        refreshBtn.setAttribute('data-download-enabled', 'true');
                        refreshBtn.textContent = 'Download & Refresh';
                        refreshBtn.onclick = async function() {
                            refreshBtn.disabled = true;
                            refreshBtn.textContent = 'Downloading...';
                            try {
                                const response = await fetch('/api/refresh-srp', {
                                    method: 'POST',
                                    headers: {'Content-Type': 'application/json'},
                                    body: JSON.stringify({download_csv: true})
                                });
                                if (response.ok) {
                                    refreshBtn.textContent = 'Loading Chart...';
                                    setTimeout(() => {
                                        loadSRPChart();
                                        refreshBtn.textContent = 'Refresh Chart';
                                        refreshBtn.disabled = false;
                                    }, 2000);
                                } else {
                                    throw new Error('Download failed');
                                }
                            } catch (err) {
                                alert('Failed to download data: ' + err.message);
                                refreshBtn.textContent = 'Download & Refresh';
                                refreshBtn.disabled = false;
                            }
                        };
                    }
                } else {
                    ctx.fillText(`Error loading ${currentChartType} data. Check console for details.`, canvas.width / 2, canvas.height / 2);
                }
            }
        }
        
        // Load chart when page loads
        loadSRPChart();
        
        // Load current status
        fetch('/api/status').then(r => r.json()).then(data => {
            if (data.eg4) {
                socket.emit('eg4_update', data.eg4);
            }
            if (data.srp) {
                socket.emit('srp_update', data.srp);
            }
        });
        
        // Close modal when clicking outside of it
        window.onclick = function(event) {
            const modal = document.getElementById('gmail-modal');
            if (event.target == modal) {
                closeGmailConfig();
            }
        };
        
        // Enhanced UX Functions
        function showToast(message, type = 'success', duration = 3000) {
            // Remove existing toasts
            const existingToasts = document.querySelectorAll('.toast');
            existingToasts.forEach(toast => toast.remove());
            
            // Create new toast
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            
            // Add to DOM
            document.body.appendChild(toast);
            
            // Show with animation
            setTimeout(() => toast.classList.add('show'), 100);
            
            // Auto remove
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 300);
            }, duration);
        }
        
        function addLoadingState(element) {
            if (element) {
                element.classList.add('loading');
            }
        }
        
        function removeLoadingState(element) {
            if (element) {
                element.classList.remove('loading');
            }
        }
        
        function animateValueChange(element, newValue) {
            if (element && element.textContent !== newValue) {
                element.classList.add('updating');
                setTimeout(() => {
                    element.textContent = newValue;
                    element.classList.remove('updating');
                }, 150);
            }
        }
        
        // Enhance existing socket handlers with animations
        const originalSocket = socket;
        
        // Override the EG4 data update handler to include animations
        socket.on('eg4_data', function(data) {
            // Add smooth animations for value updates
            const metrics = {
                'battery-soc': data.battery_soc + '%',
                'battery-power': data.battery_power + 'W',
                'pv-power': data.pv_power + 'W',
                'grid-power': data.grid_power + 'W',
                'load-power': data.load_power + 'W',
                'battery-voltage': data.battery_voltage + 'V',
                'grid-voltage': data.grid_voltage + 'V'
            };
            
            // Animate value changes
            Object.entries(metrics).forEach(([id, value]) => {
                const element = document.getElementById(id);
                if (element) {
                    animateValueChange(element, value);
                }
            });
            
            // Update PV details with animation
            if (data.pv1_power !== undefined) {
                animateValueChange(document.getElementById('pv1-power'), data.pv1_power);
                animateValueChange(document.getElementById('pv1-voltage'), data.pv1_voltage);
            }
            if (data.pv2_power !== undefined) {
                animateValueChange(document.getElementById('pv2-power'), data.pv2_power);
                animateValueChange(document.getElementById('pv2-voltage'), data.pv2_voltage);
            }
            if (data.pv3_power !== undefined) {
                animateValueChange(document.getElementById('pv3-power'), data.pv3_power);
                animateValueChange(document.getElementById('pv3-voltage'), data.pv3_voltage);
            }
            
            // Update timestamp
            document.getElementById('last-updated').textContent = new Date().toLocaleString();
            
            // Set status
            const statusElement = document.getElementById('status');
            if (statusElement) {
                statusElement.innerHTML = '<span style="color: #22c55e;">● Online</span>';
            }
        });
    </script>
</body>
</html>